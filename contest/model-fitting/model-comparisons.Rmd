---
title: "Model Comparisons"
author: "Amanda Luby, Shannon Gallagher, Kayla Frisoli"
date: "9/10/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(lme4)
library(dplyr)
library(kableExtra)
library(cowplot)
library(broom)
library(tidyr)
#load("stan-model-fits.RData")
load(file = "../../data/gs_players.rda")
load("../../data/gs.rda")

gs_players$name_int = as.integer(as.factor(gs_players$name))
gs_players$hand_fac = as.factor(gs_players$hand)
gs_players$ioc_fac = as.factor(gs_players$ioc)
gs_players$atp = gs_players$league == "ATP"
gs_players$year_fac = as.factor(gs_players$year)
gs_players$late_round = gs_players$round >= "R16"

```

### Model Fit

* Took minutes out because it was disproportionately missing for women players (and missing data gets thrown out)
* Initially began by modeling points won in the match, but found that this was not the best approach because more points won does not necessarily correspond to a better performance. 

Variables considered as predictors:

* `ioc_fac`: Country that the player represents
* `tournament`: Which Grand Slam the match was played at
* `late_round`: Indicator for whether the match occured in Round of 16 or later
* `rank`: Rank of player at the time of the match
    + Included on log scale 
* `opponent_rank`: Rank of opponent at the time of the match
    + Included on log scale
* `year`: Factor variable with a level for each year included in the dataset (2013-2017)
* `atp`: Indicator that the match was played in the ATP league instead of the WTF league

Models considered:

* No mixed effects
    + `nocourt_logistic`: $\text{logit}(\pi_i) = \beta X$, $X$ does not include `tournament`
        + If this model fits well, court surface does not have an effect on winning probability
    + `base_logistic`: $\text{logit}(\pi_i) = \beta X$
        + If this model fits better than the mixed-effects models, performance does not depend on individual-level or IOC-level 
* IOC-level effect
    + `country_logistic`: $\text{logit}(\pi_i) = \beta X + \beta_{T[i]}T$, $\beta_{T[i]} = \alpha_i C_i$
* Player-level effect
    + `ind_logistic`: $\text{logit}(\pi_i) = \beta X + \beta_{T[i]}T$, $\beta_{T[i]} = \alpha_i P_i$
    + `ind_logistic_noioc`: $\text{logit}(\pi_i) = \beta X + \beta_{T[i]}T$, where $X$ does not include IOC, $\beta_{T[i]} = \alpha_i P_i$
    + `ind_int_noioc`: $\text{logit}(\pi_i) = \beta X + \beta_{0[i]}$, where $X$ does not include IOC, $\beta_{0[i]} = \alpha_i$
    + `ind_year_logistic`: $\text{logit}(\pi_i) = \beta X + \beta_{Y[i]}$, where $X$ does not include IOC, $\beta_{Y[i]} = \alpha_i Y_i$

```{r, cache = TRUE}
nocourt_logistic = glm(did_win ~ ioc_fac + late_round + log(rank) + log(opponent_rank) + year_fac + atp, data = gs_players, family = "binomial")
base_logistic = glm(did_win ~ ioc_fac +  tournament + late_round + log(rank) + log(opponent_rank) + year_fac + atp, data = gs_players, family = "binomial")
country_logistic = glmer(did_win ~ late_round + log(rank) + log(opponent_rank) + year_fac + atp + (0 + tournament |ioc_fac), data = gs_players, family = "binomial")
ind_logistic = glmer(did_win ~  ioc_fac + late_round + log(rank) + log(opponent_rank) + year_fac + atp + (0 + tournament |name_int), data = gs_players, family = "binomial")
ind_logistic_noioc = glmer(did_win ~ late_round + log(rank) + log(opponent_rank) + year_fac + atp + (0 + tournament |name_int), data = gs_players, family = "binomial")
ind_int_logistic = glmer(did_win ~ late_round + log(rank) + log(opponent_rank) + year_fac + atp + tournament + (1|name_int), data = gs_players, family = "binomial")
ind_year_logistic = glmer(did_win ~ late_round + log(rank) + log(opponent_rank) + atp + tournament + (0+year_fac|name_int), data = gs_players, family = "binomial")

model_names = c("nocourt_logistic", "base_logistic", "country_logistic", "ind_logistic", 
                "ind_logistic_noioc", "ind_int_logistic", "ind_year_logistic")
model.sums = data.frame(model = model_names, aic = rep(NA, length(model_names)), edf = rep(NA,length(model_names)))
model.ests = data.frame()
ran.effects = data.frame()
for(mod in 1:nrow(model.sums)){
  name = model_names[mod]
  model.sums$aic[mod] = extractAIC(get(name))[2]
  model.sums$edf[mod] = extractAIC(get(name))[1]
  betas = tidy(get(name))
  betas$model = name
  if("group" %in% colnames(betas)){
  model.ests = rbind(model.ests, filter(betas, group == "fixed") %>%
    select(., -"group"))
  }
  else model.ests = rbind(model.ests, betas)
}

kable(model.sums)
```

Based on AIC, the `ind_logistic_noioc` model performed best after accounting for the number of variables in the model. 

```{r}
fixed.effects.plot = model.ests %>%
  filter(., !grepl("ioc", term)) %>%
  ggplot(., aes(x = term, y = exp(estimate), col = model, ymin = exp(estimate - 2*std.error), ymax = exp(estimate + 2*std.error))) +
  geom_errorbar(width = .7, position = position_dodge()) +
  theme_minimal() + 
  theme(axis.text.x=element_text(angle = 45, hjust = 1)) +
  scale_color_brewer(palette = "Dark2") + 
  ggtitle("Fixed effects")

```

```{r}
ran_tourn = rbind(ranef(ind_logistic)$name_int, ranef(ind_logistic_noioc)$name_int)
ran_tourn$model = c(rep("ind_logistic", nrow(ranef(ind_logistic)$name_int)), rep("ind_logistic_noioc", nrow(ranef(ind_logistic)$name_int)))

# 486, 504, 526
indices = c(486, 504, 526)
superstars = data.frame(
  name = rep(c("Serena", "Nadal", "Federer"), 2),
  model = c(rep("ind_logistic", 3), rep("ind_logistic_noioc",3)),
  `Australian Open` = c(ranef(ind_logistic)$name_int[indices,1], ranef(ind_logistic_noioc)$name_int[indices,1]),
  `French Open` = c(ranef(ind_logistic)$name_int[indices,2], ranef(ind_logistic_noioc)$name_int[indices,2]),
  `US Open` = c(ranef(ind_logistic)$name_int[indices,3], ranef(ind_logistic_noioc)$name_int[indices,3]),
  `Wimbledon` = c(ranef(ind_logistic)$name_int[indices,4], ranef(ind_logistic_noioc)$name_int[indices,4])
)

superstars = superstars %>%
  gather(., tournament, effect, -c("name", "model"))
  
random.effects.plot = ran_tourn %>%
  gather(., tourn, estimate, -model) %>%
  mutate(., tournament = gsub("tournament", "", tourn)) %>%
  ggplot(., aes(x = tournament, y = exp(estimate), fill = model)) +
  geom_violin() + 
  theme_minimal() +
  scale_fill_brewer(palette = "Dark2") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  ggtitle("Random effects")

plot_grid(fixed.effects.plot, random.effects.plot)
```

Looking at the `ind_logistic_noioc` random effects more in-depth, we see that the effects for the Austrialian Open, US Open, and Wimbledon are all quite correlated. This suggests that, after accounting for additional variables such as rank and opponent rank, differences in win probability are not detectable between the two types of hard court and grass. 

```{r}
pairs(ranef(ind_logistic_noioc)$name_int, pch = 21)
```

If we look at our big three, their individual effects are not very informative (especially after taking uncertainty into consideration). 

```{r}
name_lookup = unique(cbind(gs_players$name, gs_players$name_int))
name_lookup = name_lookup[order(as.integer(name_lookup[,2])),]
as.data.frame(ranef(ind_logistic_noioc, condVar = TRUE)) %>%
  mutate(tournament = gsub("tournament", "", term)) %>%
  mutate(name = name_lookup[,1][as.integer(grp)]) %>% 
  filter(., name == "Serena Williams" | name == "Rafael Nadal" | name == "Roger Federer") %>%
  ggplot(., aes(y = name, x = condval, xmin = condval- 2*condsd, xmax = condval + 2*condsd)) +
  facet_wrap(~tournament, scales = "free_x") + 
  geom_errorbarh(height = .5)
```

Sanity Checks:

* Serena should be good on hard surface
* Nadal should be good on clay 
* Federer should be good on grass 
