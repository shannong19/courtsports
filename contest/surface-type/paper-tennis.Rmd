---
title: "Opening up the court (surface) in tennis grand slams"
date: '`r format(Sys.time(), "%B %d, %Y")`'
output:
  pdf_document:
    fig_caption: yes
    keep_tex: yes
    number_sections: yes
header-includes:
  - \usepackage{hyperref}
abstract: "The Australian Open, The French Open, Wimbledon, and The US Open are the four most prestigious events (grand slams) in tennis and are played on four different surfaces: Plexicushion (hard court), clay, grass, and DecoTurf (hard court), respectively.  It is often thought that some players achieve better results at some grand slams than others and that difference in results may be attributed, at least partially, to the difference in the surfaces.  For example three top players of all time, Rafael Nadal, Roger Federer, and Serena Williams have achieved their best results on clay, grass, and hard courts, respectively.  In this paper, we examine the effect of surface type at grand slams from 2013-2017 for top players, adjusting for confounders such as league, competitor strength, and player attributes.  We answer the question of court effect on player results at first a high level using ``complete'' data with few features and then using partial data with a variety of tennis-specific features.  Our primary model is a hierarchical model with fixed and random effects accounting for both player and tournament features.  We show that differences in surface type become more apparent with more detailed data and that more study should be conducted in this area."
bibliography: master.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(warning=FALSE)
knitr::opts_chunk$set(message = FALSE)

library(deuce)
library(dplyr)
library(tidyr)
library(ggplot2)
library(forcats)
library(stringr)
library(knitr)
library(kableExtra)
library(gridExtra)
library(grid)
library(MASS)
library(ggrepel)
library(broom)
library(lme4)
library(cowplot)
library(ggpubr)

## To change into library(courtsports)
library(courtsports)

```


```{r data-cleaning, include = FALSE}
data(gs)
data(gs_players)
data(gs_partial)
data(gs_partial_players)

```

```{r graphing-parameters, include = FALSE}
my_theme <-  theme_bw() + # White background, black and white theme
  theme(axis.text = element_text(size = 12),
        text = element_text(size = 14,
        family="serif"),
        plot.title = element_text(hjust = 0.5, size=16))

tournament_colors <- c("#0297DB", "#b06835", "#0C2340", "#54008b")
league_colors <- c("#0C2340", "#902BA3")
win_colors <- c("#336699", "#339966")

# with yellow for us
tournament_colors <- c("#0297DB", "#b06835", "#ffe500", "#54008b")

```


```{r modelling, eval = FALSE}
## HIERARCHICAL MODELLING
## NOT RUN
## WARNING: Takes about 1 HOUR

gs_players$name_int = as.integer(as.factor(gs_players$name))
gs_players$hand_fac = as.factor(gs_players$hand)
gs_players$ioc_fac = as.factor(gs_players$ioc)
gs_players$atp = gs_players$league == "ATP"
gs_players$year_fac = as.factor(gs_players$year)
gs_players$late_round = gs_players$round >= "R16"
gs_players$seeded = gs_players$rank <= 32
gs_players$opponent_seeded = gs_players$opponent_rank <= 32

set.seed(091418)
nocourt_logistic = glm(did_win ~ ioc_fac + late_round + log(rank) + log(opponent_rank) + year_fac + atp, data = gs_players, family = "binomial")
base_logistic = glm(did_win ~ ioc_fac +  tournament + late_round + log(rank) + log(opponent_rank) + year_fac + atp, data = gs_players, family = "binomial")
country_logistic = glmer(did_win ~ late_round + log(rank) + log(opponent_rank) + year_fac + atp + (0 + tournament |ioc_fac), data = gs_players, family = "binomial")
ind_logistic = glmer(did_win ~  ioc_fac + late_round + log(rank) + log(opponent_rank) + year_fac + atp + (0 + tournament |name_int), data = gs_players, family = "binomial")
ind_logistic_noioc = glmer(did_win ~ late_round + log(rank) + log(opponent_rank) + year_fac + atp + (0 + tournament |name_int), data = gs_players, family = "binomial")
ind_int_logistic = glmer(did_win ~ late_round + log(rank) + log(opponent_rank) + year_fac + atp + tournament + (1|name_int), data = gs_players, family = "binomial")
ind_year_logistic = glmer(did_win ~ late_round + log(rank) + log(opponent_rank) + atp + tournament + (0+year_fac|name_int), data = gs_players, family = "binomial")
n_aces_mod = lmer(n_aces ~ late_round + log(rank) + log(opponent_rank) + year_fac + atp + (0 + tournament |name), data = gs_partial_players)
n_winners_mod = lmer(n_winners ~ late_round + log(rank) + log(opponent_rank) + year_fac + atp + (0 + tournament |name), data = gs_partial_players)
n_net_mod = lmer(n_netpt_w ~ late_round + log(rank) + log(opponent_rank) + year_fac + atp + (0 + tournament |name), data = gs_partial_players)
n_ue_mod = lmer(n_ue ~ late_round + log(rank) + log(opponent_rank) + year_fac + atp + (0 + tournament |name), data = gs_partial_players)


```

# Introduction {#sec:intro}

The four tennis grand slams ( Australian Open (AO), French Open (FO),  Wimbledon (Wim.), US Open (USO)) are played in different cities (Melbourne, Paris, London, New York City) at different times of year (January, May, June, August) over the course of two weeks with 7 total rounds and 128 players for both men (ATP) and women (WTA).  All four slams are played on different surfaces (Plexicushion hard court, clay, grass, DecoTurf hard court).  It is often thought that top players achieve better results on some surfaces than others.  For example, there is the idea of "home court advantage" in which players from the country of the grand slam tournament are thought to perform better than at other grand slams.  Recently, Spanish players, led by Nadal, seem to have dominated the clay court scene [@tp2018] making it seem like players of a certain country may perform better on some surfaces than others.

Rafael Nadal is known as the "King of Clay" in tennis, having won 11 out of his current 17 grand slams titles at the French Open, which is played on a clay surface [@bbc2018].  In contrast, his rival Roger Federer has won the greatest proportion of his grand slam titles (8 out of 20) at Wimbledon, which is played on grass.  On the women's side, Serena Williams, winner of 24 grand slam titles, has been dominant both on hard court (7 titles at the Australian Open and 6 at US Open) and grass (7 at Wimbledon).  

In this paper, we use the results of grand slam players from 2013-2017 to analyze the effect of court surface on player performance at the four grand slams. We examine court surface across all participants in grand slams, and also investigate player effects.  The goals of this work are to:

1. Determine if results (in terms of wins/losses and point distributions) differ across the four surfaces

2. Examine tennis specific attributes such as winners, aces, and unforced errors across the four surfaces

3. Assess how players perform across the four surfaces, with focus on Nadal, Federer, and Williams.

There has been little work on quantifying the high-level effect of court surface in tennis (issue 1). Existing literature provides methods for forecasting the outcome of tennis matches [@klaassen2003; @newton2005; @mchale2011; @kovalchik2016]] or for assessing whether points within a match are independent and identically distributed [@klaassen2001]. @knottenbelt2012 take court surface into account in their model, but do not compare the results of one surface to another, and @pollard2007 conclude that players have more injuries on grass compared to other courts. Results from studies performed in other sports show that surface type does have an effect on the game, either directly or indirectly [@andersson2008; @gains2010].

We examine the match attributes more unique to tennis to address (issue 2). These attributes include winners (when a player hits a shot that the opponent is unable to return), aces (a serve an opponent is unable to return), and unforced errors (UE) (when a player makes a simple mistake resulting in a loss of the point).  In general, players hope to maximize the winner to UE ratio (W/UE), which may lead to playing more aggressively on faster courts and more conservatively on slower courts such as clay [@theage2007].

Finally, to assess how individual players differ in performance across surfaces, (issue 3), we take two approaches.  The first is to use a hierarchical model with fixed and random effects, taking into account player and tournament attributes using the complete data set.  This allows us to leverage tournament information to model players with few matches played and to help account for noise.  Our second approach is to model performance for specific players individually. Since Nadal, Federer, and Williams are extremely popular and have had much success in the 2013-2017 time range, we have enough data points with tennis-specific feature attributes to examine the effects individually.  In both cases, we examine whether our models pass "common sense" tests like how the models in @thomas2013 show that commonly well known hockey players also have high status in the model.  We also examine whether these players do have court surface effects. For the individual models, we do not split the data into training and test sets due to the relatively low number of observations for the individuals.  However, when the data becomes available, we would like to test these models on the 2018 grand slam results. For model selection, we use AIC to compare models to one another [@wasserman2004].  

Few academic papers have been written about Nadal, Federer, or Williams.  One paper studies Federer's odds of winning when Nadal suddenly withdrew from Wimbledon and shows that Federer was too heavily favored by bookmakers [@leitner2009].  One analysis of Williams shows how she has gotten better with age, even past the point when other greats began to decline, but the study does not look at surface type [@five2015].

Readers may object that we are looking at differences between grand slams, which each have their own time period, weather conditions, play time conditions, and "home court effects" instead of differences in surfaces alone.  However, (1) grand slam data is the most readily available and most complete which makes it the best choice at the moment for modelling, (2) we adjust for these confounders where we can, and (3) analyzing the difference in the grand slams is still useful as they are considered to be the most prestigious events in tennis.

The rest of this paper is organized as follows. In [Section Data](#sec:data) we describe our grand slam tennis data.  In [Section Early Data Analysis](#sec:eda) we examine the data at a high level and use clustering methods to determine how the courts differ from one another.  In [Section Methods](#sec:methods) we describe our models with (1) complete data with few features and (2) partial data with more features.  In [Section Results](#sec:results) we describe the results of our modelling and also examine the play of Nadal, Federer, and Williams.  Finally in [Section Discussion](#discussion), we summarize our results and discuss future work. 

# Data and EDA {#sec:data-eda}

## Data {#sec:data}

The primary data consists of `r nrow(gs)` matches split evenly over the four grand slams and the two leagues: ATP (men's) and WTA (women's).  There are `r nrow(gs)` observations in this data set, which corresponds to a complete data set for the period of 2013-2017 for four grand slams, two leagues, and seven rounds.  Each match has `r ncol(gs)` attributes, many of which are redundant.  We focus on the following attributes for both the winner and loser of the match: games won, points won, retirement, break points faced, break points saved, aces, country of origin, and player attributes.  Additionally, we take into account the number of sets in a match, the court surface, and round of the tournament.  A subset of the data is shown in Table \ref{tab:data}.

```{r tab-data, include = TRUE, echo = FALSE}
w_id <- which(gs$winner_name == "Serena Williams")[1]
f_id <- which(gs$winner_name == "Roger Federer")[1]
n_id <- which(gs$winner_name == "Rafael Nadal")[1]
s_id <- which(gs$winner_name %in% c("Serena Williams", "Roger Federer", "Rafael Nadal"))
cols <- c("winner_name", "tourney_name", "year", "winner_ioc", "w_pointswon", "winner_rank", "l_pointswon", "loser_rank")
knitr::kable(gs[c(w_id, f_id, n_id), cols], format = "latex",
             row.names = FALSE, col.names = c("Winner", "Tournament", "Year", "W. IOC", "W. Points",  "W. Rank", "L. Points", "L. Rank"),
             caption = "\\label{tab:data}Example of the complete grand slam data.  It includes winner and loser attributes, match attributes, and tournament attributes.  Not all attributes are shown here.",
             booktabs = TRUE) %>% kable_styling(latex_options = "striped", "hold_position")
```

The secondary data is partial point by point data for grand slam matches.  In this data set, each row is a point in a match with details on who won the point, serve speed, and whether a player had a forced or unforced error, winner, ace, or net point win.  There is also tournament info such as court surface, year, and time start.  Additional attributes include rally length, winner and final score of the match, retirement, and minutes played.  However, these additional attributes are only available for about 1/8 of the data.   This partial data set consists of `r nrow(gs_partial)` observations (compared to the 5080 in the original grand slams).  The median rank of the winners for the original data is `r median(gs$winner_rank, na.rm = TRUE)`, and the median rank for the winners of the partial data is `r median(gs_partial$winner_rank)`.  The same trend is true for the loser rank.  This means that it is more likely for better players to have court by court data, which may affect our analysis for models when using this more detailed yet partial data.  Additionally, we found that no women's point by point data was recorded for 2015.

```{r table, fig.pos = 'H'}
top_three <- dplyr::filter(gs_players, name %in% c("Rafael Nadal", "Roger Federer", "Serena Williams"))
matches_played_slam_year <- top_three %>% group_by(name, tournament, year) %>%
  summarize(matches_played = n())
matches_played_slam <- matches_played_slam_year %>% group_by(name, tournament) %>%
  summarize(matches_played = sum(matches_played))
tab <- spread(matches_played_slam, key = name, value = matches_played)
total_df <- data.frame(tournament = "Total", as.list(colSums(tab[,-1])))
colnames(total_df) <- colnames(tab)
tab <- rbind(tab, total_df)

knitr::kable(tab, format = "latex",
               row.names = FALSE, col.names = c("Tournament", "Nadal", "Federer", "Williams"),
               caption = "\\label{tab:three-gs-counts}\\# of matches played for Nadal, Federer, and Williams from 2013-2017 at each of the grand slams.",
               booktabs = TRUE) %>% kable_styling(latex_options = "striped", "HOLD_position") %>%
    row_spec(5, bold = TRUE, background = "lightgray")
```

In Table \ref{tab:three-gs-counts}, we display the number of matches Nadal, Federer, and Williams have played from 2013-2017.  Over that time span, Nadal won 6 grand slams, Federer won 1, Williams won 8.  Despite this, Federer played more total matches in Nadal.  All three players were absent for exactly three slams during this time period due to external factors.  Not unexpectedly, Nadal has the most wins at FO (`r tab[2, 2]`), Federer has the most wins at Wim. (`r tab[4, 3]`), and Williams the most on hardcourt (`r tab[1, 4]` at AO and `r tab[4, 4]` at US Open).  

All data is obtained from Jeff Sackmann's open website via the `R` package `deuce` [@sackmann2018; @deuce2017].  All steps of our analysis from collection to dissemination are freely available online.


## Early Data Analysis {#sec:eda}
### Examining the distribution of points earned

We first determine whether the distribution of points comes from a normal distribution.  We plot the distribution of points in Figure \ref{fig:distr-eda} (left), and the distribution does seem approximately normal. This distribution is similar across tournament, with Wimbledon differing slightly from the other grand slams. As expected, there are more points earned in the WTA than the ATP (Fig. \ref{fig:distr-eda} (right)) due to the differing number of sets played. Also unsurprisingly, the winners of the match tended to earn more points than the losers.   

```{r, fig.height=5, fig.width=10, fig.cap="\\label{fig:distr-eda} Distribution of number of points for the different grand slams (left) and distribution of points per match faceted by winner and loser for the two leagues (right)."}

# grid.arrange(p1, p2, p3, ncol=3, widths=c(.25, .41, .34),)


p2 <- ggplot(gs_players) + geom_density(aes(pointswon, color = tournament)) + 
  labs(x = "Points") + my_theme +
  scale_color_manual("Tournament", values=tournament_colors)

p3 <- ggplot(gs_players) + geom_density(aes(pointswon, color = league))+ 
  labs(x = "Points") +
  scale_color_manual("League", values=league_colors) +
  my_theme


# grid.arrange( p2, p3, ncol=2,
#              top = textGrob("Winning points by tournament and league",
#                             gp=gpar(fontsize=20)))

p1 <- ggplot(gs_players) + geom_density(aes(pointswon, color = factor(did_win))) + 
  labs(x = "Points") +
  scale_color_manual("Winner?", values=win_colors) +
  my_theme +
  facet_wrap(~league, ncol=1)

grid.arrange(p1, p2, ncol=2,
             top = textGrob("Distribution of points per match",
                            gp=gpar(fontsize=20, fontfamily="serif")),
              layout_matrix = rbind(c(NA, 1),
                                    c(2, 1),
                                    c(NA, 1)),
             heights=c(1, 3, 1))

```


### Home court advantage 

It is commonly thought that there is a home court advantage in grand slam matches [@sb2013]. In our data, we find this to be true (e.g. French players win the French open more than French players win other slams). However, we also know that the home team is given preference for wild card bids [@usta2018] so potentially citizens of a given country play in "their" tournament more often than they play in other tournaments. We also find this to be true in our data for France, the United States, Australia, and Great Britain (e.g. the proportion of French players in the French Open is greater than the proportion of French players in other slams). 

Therefore, we want to see how the proportion of wins for the home country changes across the different tournaments. If there really is a home court advantage, the proportion of French wins each round would be higher at the FO than the AO, the USO, and Wim.. The same would be true for Australia, the US, and Great Britain. However, in Figure \ref{fig:home-court} that this is not the case. After accounting for the number of players from each country, we do not find a home court advantage in the grand slams. 

```{r, fig.height=3.5, fig.width=10, fig.align='center', fig.pos = 'H', fig.cap = "\\label{fig:home-court} A home court advantage does not appear to exist in any of the grand slams after we account for the number of players from a given country."}
france_wins <- filter(gs_players, ioc == "FRA", round < "QF") %>% 
  group_by(tournament, round) %>% 
  summarise(win_prop = mean(did_win),
            win_prop_se = sqrt(win_prop*(1-win_prop)/n()))

us_wins <- filter(gs_players, ioc == "USA", round < "QF") %>% 
  group_by(tournament, round) %>% 
  summarise(win_prop = mean(did_win),
            win_prop_se = sqrt(win_prop*(1-win_prop)/n()))

aus_wins <- filter(gs_players, ioc == "AUS", round < "QF") %>% 
  group_by(tournament, round) %>% 
  summarise(win_prop = mean(did_win),
            win_prop_se = sqrt(win_prop*(1-win_prop)/n()))

gbr_wins <- filter(gs_players, ioc == "GBR", round < "QF") %>% 
  group_by(tournament, round) %>% 
  summarise(win_prop = mean(did_win),
            win_prop_se = sqrt(win_prop*(1-win_prop)/n()))

p1<- ggplot(france_wins, aes(round, win_prop, color=tournament, group=tournament)) + 
  geom_line() + 
  # geom_point() +
  labs(title = "French players",
       x = "", y = "Win proportion") + 
  scale_color_manual(" ", values=tournament_colors) + my_theme

p2 <- ggplot(us_wins, aes(round, win_prop, color=tournament, group=tournament)) + 
  geom_line() + 
  # geom_point() +
  labs(title = "American players",
       x = "", y = "Win proportion") +  
  scale_color_manual(" ", values=tournament_colors)  + my_theme

p3 <- ggplot(aus_wins, aes(round, win_prop, color=tournament, group=tournament)) + 
  geom_line() + 
  # geom_point() +
  labs(title = "Australian players",
       x = "", y = "Win proportion") + 
  scale_color_manual(" ", values=tournament_colors) + my_theme


p4 <- ggplot(gbr_wins, aes(round, win_prop, color=tournament, group=tournament)) + 
  geom_line() + 
  # geom_point() +
  labs(title = "British players",
       x = "", y = "Win proportion") + 
  scale_color_manual(" ", values=tournament_colors) + my_theme

ggarrange(p3, p1, p2,  p4, nrow=1, ncol=4, common.legend = TRUE, legend="bottom") %>%
grid.arrange(., top = textGrob("Home court advantage: debunked",
                            gp=gpar(fontsize=20, fontfamily="serif")),
             bottom = textGrob("Note: we only look at the first 4 rounds due to decreasing sample size",
                           just = "left",
                           gp=gpar(fontfamily="serif")))

```


## Spaniards on clay

```{r}

spain_wins <- filter(gs_players, ioc == "ESP", round < "QF") %>% 
  group_by(tournament, round) %>% 
  summarise(win_prop = mean(did_win),
            win_prop_se = sqrt(win_prop*(1-win_prop)/n()),
            avg_ranking = mean(rank),
            rank_se = sd(rank)/sqrt(n()))

chisq_r128 <- with(filter(gs_players, ioc == "ESP", round == "R128"),
     table(did_win, tournament)) %>%
  chisq.test(correct = TRUE)

chisq_r64 <- with(filter(gs_players, ioc == "ESP", round == "R64"),
     table(did_win, tournament)) %>%
  chisq.test(correct = TRUE)

chisq_r32 <- with(filter(gs_players, ioc == "ESP", round == "R32"),
     table(did_win, tournament)) %>%
  chisq.test(correct = TRUE)

chisq_r16 <- with(filter(gs_players, ioc == "ESP", round == "R16"),
     table(did_win, tournament)) %>%
  chisq.test(correct = TRUE)

```


It is also commonly thought that Spaniards play better on clay. We are interested in whether Spaniards win matches at the French Open more than they win in other tournaments. It does appear that Spaniards are winning the French Open more than they are winning other tournaments as the line in Figure \ref{fig:spain-clay} for the French Open is consistently higher than the other tournaments. However, this result is not significant at any round (p-value = `r round(chisq_r128$p.value, 2)`, `r round(chisq_r64$p.value, 2)`, `r round(chisq_r32$p.value, 2)`, `r round(chisq_r16$p.value, 2)`). The ranking of Spaniards in the French Open is, on average, higher than other tournaments, meaning that, on average Spanish players in the French Open are worse in ranking yet winning more often. 

```{r, fig.height=3.8, fig.width=8, out.width="80%", fig.align='center',  fig.pos = 'H',  fig.cap = "\\label{fig:spain-clay} Spaniards win more often at the French Open than other slams, even though their ranking is, on average, lower than their ranking at other tournaments."}

p1 <- ggplot(spain_wins, aes(round, win_prop, color=tournament, group=tournament)) + 
  geom_line() + 
  labs(title = "Win proportion among Spaniards",
       # caption = "Note: we only look at the first 4 rounds due to decreasing sample size",
       x = "", y = "Win proportion") + 
  scale_color_manual(guide=FALSE, values=tournament_colors) + my_theme  

p2 <- ggplot(spain_wins, aes(round, avg_ranking, color=tournament, group=tournament)) + 
  geom_line() + 
  labs(title = "Average ranking among Spaniards",
       x = " ",
       y = "Average rank") + 
  scale_color_manual(" ", values=tournament_colors) + my_theme 


ggarrange( p1, p2, nrow=1, ncol=2, common.legend = TRUE, legend="bottom") %>%
grid.arrange(top = textGrob("Spaniards perform better on Clay: confirmed",
                            gp=gpar(fontsize=20, fontfamily="serif")),
             bottom = textGrob("Note: we only look at the first 4 rounds due to decreasing sample size",
                           # x = 0,
                           # y = 0.5,
                           just = "left",
                           gp=gpar(fontfamily="serif")))

```


## Unforced errors and aces

We find that the distribution of UEs and aces differ by tournament.  In Figure \ref{fig:ue-ace} we plot the total aces in a match vs. the total unforced errors in a match and color by the tournament. Specifically, matches in Wimbledon follow different ace and error patterns than the other tournaments. These matches tend to cluster in the upper left hand part of the graph, meaning that at Wimbledon players are making fewer unforced errors and scoring more aces. It is thought that the ball moves faster on grass courts and so the ace result is unsurprising, but making fewer errors is unexpected, especially because players seldom practice on grass. 

```{r, out.width="70%", fig.width=7, fig.height=3.4, fig.align='center', fig.cap= "\\label{fig:ue-ace}We see Wimbledon matches tend to have more aces and fewer unforced errors than the other tournaments."}
ggplot(gs_partial, aes(w_n_ue + w_n_ue, w_n_aces + w_n_aces,
                           label = tournament, color=tournament)) + 
  geom_jitter() +
  labs( title = "Distribution of errors and aces differ by tournament",
        x = "Total unforced errors", y = "Total aces") +
  my_theme + scale_color_manual("Tournament", values = tournament_colors)

```


# Methods {#sec:methods}

## Hierarchical models

We use a hierarchical modeling approach to examine the grand slam results from all players from 2013-2017. This allows us to include fixed effects, which remain the same for each player, along with player-level individual effects. Since players appear multiple times in the data, the observations are not independent and including a player-level effect allows us to account for this dependence. It also provides a way to assess individual player effects.

### Modeling wins with logistic regression

We initially planned to use points won by an individual as our outcome variable, but found that it may not be an ideal measure of player performance. For instance, players may score few points in a match due to a poor performance, but they may also score few (relative) points if they win a short match. Modeling the number of points won is also complicated by the difference between length of matches for men (best of 5 sets) and women (best of 3 sets). For these reasons, we chose to model whether a player won the match using a hierarchical logistic regression approach, with possible covariates including country of origin (IOC), tournament that the match was played at, whether the match occurred in Round of 16 or later, rank of player, rank of opposing player, year of the match, and whether it was a men's or women's match.

We considered a variety of models incorporating effects as either fixed or random. That is $E[Y_{\% pts. won}|X] = \beta X$, where $E[\pi_i|X_i, \delta_i] = \beta X_i + \delta_i$ (i.e. a player win), $X_i$ are the fixed effects included in the model, and $\delta_i$ is a random effect across either players or years. Based on AIC, we found the model that included a player-level term for each tournament, but excluded fixed terms for country, was the best fit for the data. The models are summarized in Table \ref{tab:model.sums}.


```{r}
load("../../data/gs_players.rda")
load("../../data/gs_partial_players.rda")
load("../../data/nocourt_logistic.rda")
load("../../data/base_logistic.rda")
load("../../data/country_logistic.rda")
load("../../data/ind_int_logistic.rda")
load("../../data/ind_logistic.rda")
load("../../data/ind_logistic_noioc.rda")
load("../../data/ind_year_logistic.rda")
```
        

```{r, warning = FALSE}
model_names = c("nocourt_logistic", "base_logistic", "country_logistic", "ind_logistic", 
                "ind_logistic_noioc", "ind_int_logistic", "ind_year_logistic")
model.sums = data.frame(model = model_names, aic = rep(NA, length(model_names)), edf = rep(NA,length(model_names)))
model.ests = data.frame()
ran.effects = data.frame()
for(mod in 1:nrow(model.sums)){
  name = model_names[mod]
  model.sums$aic[mod] = extractAIC(get(name))[2]
  model.sums$edf[mod] = extractAIC(get(name))[1]
  betas = tidy(get(name))
  betas$model = name
  if("group" %in% colnames(betas)){
  model.ests = rbind(model.ests, filter(betas, group == "fixed") %>%
    dplyr::select(., -c("group")))
  }
  else model.ests = rbind(model.ests, betas)
}

model.sums$name = c("no_court", "no_random_ef", "country_ef", "ind_ef", "ind_no_ioc", "ind_intercept", "ind_year_ef")
model.sums$fixed = c("No country, no tournament",
                     "all",
                     "no country, no tournament",
                     "no tournament",
                     "no country, no tournament",
                     "no country",
                     "no country, no year")
model.sums$random = c("none",
                      "none",
                      "tournament (by country)",
                      "tournament (by individual)",
                      "tournament (by individual)",
                      "intercept (by individual)",
                      "year (by individual)")

knitr::kable(model.sums[,c("name", "fixed", "random", "aic", "edf")], format = "latex",
             row.names = FALSE, col.names = c("Model", "Fixed Effects", "Random Effects", "AIC", "EDF"),
             caption = "\\label{tab:model.sums}AIC summary of the seven logistic regression models fitted. Including individual effects for each grand slam, without including any country effects, leads to the best model fit according to AIC.",
             booktabs = TRUE) %>% kable_styling(latex_options = "striped")
```

If we examine the fixed effects for all seven models (see Fig. \ref{fig:mixed-mods-ests} (left)), we see that the parameter estimates do not substantially change across models. Rank and opponent rank appear to best explain the probability of winning the match. Other fixed effects in the models (whether it was a late round in the grand slam, the year, or ATP/WTA) were not found to be significantly different than zero. If we look at the random effects (see Fig. \ref{fig:mixed-mods-ests} (right)) for Williams, Federer, and Nadal, however, the individual effects are not informative (especially after taking uncertainty into consideration). 

```{r, fig.height = 3.8, fig.width=10, fig.cap ="\\label{fig:mixed-mods-ests}Estimated fixed effects for all seven models (left) and player-level effects  for Williams, Federer and Nadal (right) under the ind_no_ioc model."}
fixed.effects.plot = model.ests %>%
  filter(., !grepl("ioc", term)) %>%
  ggplot(., aes(x = term, y = estimate, col = model, ymin = estimate - 2*std.error, ymax = estimate + 2*std.error)) +
  geom_errorbar(width = .7, position = position_dodge()) +
  my_theme +
  # coord_flip() +
  theme(axis.text.x=element_text(angle = 30, hjust = 1)) +
  ggtitle("Fixed effects") +
  scale_color_brewer("",palette = "Dark2") +
  theme(legend.position = "bottom", legend.text=element_text(size=8),
        # legend.margin=margin(0, 0, 0, 0),
        legend.margin=margin(t = 0, unit='cm'),
        legend.box.margin=margin(-10,-10,-10,-10)) + 
  xlab("") +
  ylab("Estimate") +
  scale_x_discrete("", breaks = waiver(), labels = c("Intercept", "ATP", "Late round", "Op Rank (log)", "Rank (log)", "French", "US", "Wimbledon", "2014", "2015", "2016", "2017"))+
  guides(col = guide_legend(nrow=2))

ran_tourn = rbind(ranef(ind_logistic)$name_int, ranef(ind_logistic_noioc)$name_int)
ran_tourn$model = c(rep("ind_logistic", nrow(ranef(ind_logistic)$name_int)), rep("ind_logistic_noioc", nrow(ranef(ind_logistic)$name_int)))

random.effects.plot = ran_tourn %>%
  gather(., tourn, estimate, -model) %>%
  mutate(., tournament = gsub("tournament", "", tourn)) %>%
  ggplot(., aes(x = tournament, y = estimate, fill = model)) +
  geom_violin() + 
  my_theme +
  scale_fill_brewer(palette = "Dark2") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  ggtitle("Random effects") +
  theme(legend.position = "bottom", legend.text=element_text(size=8)) +
  guides(col = guide_legend(nrow=3))

gs_players$name_int = as.integer(as.factor(gs_players$name))
name_lookup = unique(cbind(gs_players$name, gs_players$name_int))
name_lookup = name_lookup[order(as.integer(name_lookup[,2])),]
top_three_ranef = as.data.frame(ranef(ind_logistic_noioc, condVar = TRUE)) %>%
  mutate(tournament = gsub("tournament", "", term)) %>%
  mutate(name = name_lookup[,1][as.integer(grp)]) %>% 
  filter(., name == "Serena Williams" | name == "Rafael Nadal" | name == "Roger Federer") %>%
  ggplot(., aes(x = name, y = condval, ymin = condval- 2*condsd, ymax = condval + 2*condsd, color = tournament)) +
  geom_errorbar(width = .5, position = "dodge") + 
  xlab("") + 
  ylab("Estimate") + 
  scale_color_manual("", values=tournament_colors) +
  my_theme +
  coord_flip() +
  ggtitle("Random Effects") +
  theme(legend.position = "bottom") + 
  guides(col = guide_legend(nrow=2)) + 
  theme(legend.text=element_text(size=8))

grid.arrange(fixed.effects.plot, top_three_ranef, nrow = 1, widths = c(.5, .5),
             top = textGrob("Parameter estimates from logistic model",
                            gp=gpar(fontsize=20, fontfamily="serif")))
```

More broadly, the effects for the Australian Open, US Open, and Wimbledon are all quite correlated (see Table \ref{tab:corr}). This suggests that, after accounting for additional variables such as rank and opponent rank, differences in win probability are detectable between clay and the other surfaces, but not among the hard courts and grass.

```{r, fig.pos = 'H'}
knitr::kable(round(cor(ranef(ind_logistic_noioc)$name_int),2), format = "latex",
             row.names = FALSE, col.names = c("Australian Open", "French Open", "US Open", "Wimbledon"),
             caption = "\\label{tab:corr}Correlation matrix for random effects",
             booktabs = TRUE) %>% kable_styling(latex_options = "striped")
```

### Linear regression for other outcomes

Instead of using `win' as the outcome variable, we now look at match statistics that may be more sensitive to court surface -- aces, net points won, and UEs -- and see if individual differences among players are detectable. We fit three additional models, each of the form $Y_i = \beta X_i + \delta_i$, where $\delta_i = \alpha_i T_i$, $T_i$ is the four grand slam tournaments, and $X_i$ includes the same variables as the model above. 

```{r, eval = FALSE}
gs_partial_players$atp = gs_partial_players$Tour == "atp"
gs_partial_players$year_fac = as.factor(gs_partial_players$year)
gs_partial_players$late_round = gs_partial_players$round >= "R16"
gs_partial_players$seeded = gs_partial_players$rank <= 32
gs_partial_players$opponent_seeded = gs_partial_players$opponent_rank <= 32
n_aces_mod = lmer(n_aces ~ late_round + log(rank) + log(opponent_rank) + year_fac + atp + (0 + tournament |name), data = gs_partial_players)
n_winners_mod = lmer(n_winners ~ late_round + log(rank) + log(opponent_rank) + year_fac + atp + (0 + tournament |name), data = gs_partial_players)
n_net_mod = lmer(n_netpt_w ~ late_round + log(rank) + log(opponent_rank) + year_fac + atp + (0 + tournament |name), data = gs_partial_players)
n_ue_mod = lmer(n_ue ~ late_round + log(rank) + log(opponent_rank) + year_fac + atp + (0 + tournament |name), data = gs_partial_players)
```

```{r}
load("../../data/n_aces_mod.rda")
load("../../data/n_net_mod.rda")
load("../../data/n_ue_mod.rda")
load("../../data/n_winners_mod.rda")
```

```{r, fig.height = 3.3, fig.width=10,  fig.cap = "\\label{fig:mixed-mods-stats}Estimated player-level effects for Williams, Federer and Nadal when modeling aces, net winners, and unforced errors."}
aces_ranef = as.data.frame(ranef(n_aces_mod, condVar = TRUE)) %>%
  mutate(tournament = gsub("tournament", "", term)) %>%
  filter(., grp == "Serena Williams" | grp == "Rafael Nadal" | grp == "Roger Federer") %>%
  ggplot(., aes(x = as.character(grp), y = condval, ymin = condval- 2*condsd, ymax = condval + 2*condsd, col = tournament)) +
  geom_errorbar(height = .5, position = position_dodge()) +
  ylab("Estimate") + 
  xlab("") +
  ggtitle("Aces") + 
  scale_color_manual("", values=tournament_colors) +
  my_theme +
  coord_flip() +
  theme(legend.position = "none")

winners_ranef = as.data.frame(ranef(n_winners_mod, condVar = TRUE)) %>%
  mutate(tournament = gsub("tournament", "", term)) %>%
  filter(., grp == "Serena Williams" | grp == "Rafael Nadal" | grp == "Roger Federer") %>%
  ggplot(., aes(x = as.character(grp), y = condval, ymin = condval- 2*condsd, ymax = condval + 2*condsd, col = tournament)) +
  geom_errorbar(height = .5, position = position_dodge()) +
  ylab("Estimate") + 
  xlab("") +
  ggtitle("Winners") + 
  scale_color_manual("", values=tournament_colors) +
  my_theme +
  theme(axis.text.y = element_blank()) +
  coord_flip()  # +
  # theme(legend.position = "none")

nets_ranef = as.data.frame(ranef(n_net_mod, condVar = TRUE)) %>%
  mutate(tournament = gsub("tournament", "", term)) %>%
  filter(., grp == "Serena Williams" | grp == "Rafael Nadal" | grp == "Roger Federer") %>%
  ggplot(., aes(x = as.character(grp), y = condval, ymin = condval- 2*condsd, ymax = condval + 2*condsd, col = tournament)) +
  geom_errorbar(height = .5, position = position_dodge()) +
  ylab("Estimate") + 
  xlab("") +
  ggtitle("Net Wins") + 
  scale_color_manual("", values=tournament_colors) +
  my_theme +
  theme(axis.text.y = element_blank()) +
  coord_flip() # +
  # theme(legend.position = "none")

ue_ranef = as.data.frame(ranef(n_ue_mod, condVar = TRUE)) %>%
  mutate(tournament = gsub("tournament", "", term)) %>%
  filter(., grp == "Serena Williams" | grp == "Rafael Nadal" | grp == "Roger Federer") %>%
  ggplot(., aes(x = as.character(grp), y = condval, ymin = condval- 2*condsd, ymax = condval + 2*condsd, col = tournament)) +
  geom_errorbar(height = .5, position = position_dodge()) +
  ylab("Estimate") + 
  xlab("") +
  ggtitle("Unforced Errors") + 
  scale_color_manual("", values=tournament_colors) +
  my_theme +
  theme(axis.text.y = element_blank()) +
  coord_flip()# + 
  #theme(legend.text=element_text(size=10))

#grid.arrange(aces_ranef, nets_ranef, ue_ranef, nrow = 1, widths = c(.38, .22, .45))

ggarrange(aces_ranef, nets_ranef, ue_ranef, nrow=1, ncol=3,
          common.legend = TRUE, legend="bottom", widths = c(.4, .3, .3)) %>%
grid.arrange(top = textGrob("Player-level effects",
                            gp=gpar(fontsize=20, fontfamily="serif")))

```

If we look at the random effects for Williams, Federer, and Nadal (see Fig. \ref{fig:mixed-mods-stats}), differences are much more noticeable than in the logistic regression model. For instance, we would expect Williams to have more aces at the AO and Wim. than at FO. We also see that Federer's performance at Wimbledon is consistently better than other tournaments in both aces and unforced errors. Interestingly, an increased performance on clay is not observed for Nadal in aces, net winners, or unforced errors. 

## Modeling players individually

We also fit individual linear models for Williams, Federer, and Nadal (subsetting the partial data to their matches only).  We estimate the percent of points won in a match using forward-backwards stepwise regression.  The lower model is the percent of points regressed on the opponent rank and indicator variables for surface with one court as the reference variable (in the below equation, the reference surface as FO),
$$
E[Y_{\% pts. won}|X] = \beta_0 + \beta_1 X_{opp. rank} + \beta_{2, AO}\mathcal{I}(X_{sur.} = AO)  + \beta_{2, Wim.}\mathcal{I}(X_{sur.} = Wim.) + \beta_{2, USO}\mathcal{I}(X_{sur.} = USO)  .
$$  
The full model is the lower model with the additional variables of winner to unforced error ratio (W/UE), average serve speed, percent aces, percent break points, percent net points won, and their interaction effects with court type.  We do not display the full best fit models here, but they are available online.  We do report the effects ($\pm 2 \cdot$ Std. Err.) of significant variables and their interaction terms, adjusting for the other covariates.  Since we postulated that Nadal is best on clay, Federer on grass, and Williams on hard court, specifically at AO, we use the FO, Wim., and AO, respectively, as the reference variable in the model.  For Nadal and Federer we use forward-backwards stepwise regression, using AIC as the criterion, beginning with the full model.  For Williams, we also use forwards-backwards stepwise regression but begin at the low model since she has more missing data.


## Nadal: King of Clay: confirmed



```{r nadal-model}

step_model_n <- courtsports:::model_individual(player_name = "Rafael Nadal", data = gs_partial_players)

std_res_n <- rstandard(step_model_n)

gn <- ggplot(lm(step_model_n$formula, data = step_model_n$data)) + geom_hline(yintercept = 0, col = "red") +
  geom_point(aes(x=.fitted, y = .stdresid)) + my_theme + ylim(-3, 3) +
  labs(title = "Nadal",
       x = "Predicted Percent of Points Won", y = "Standardized Residuals")


coefs_n <- coefficients(step_model_n)
cov_n <- vcov(step_model_n)
```


Looking at Nadal individually, the model with the lowest AIC has positive coefficients for opponent rank, percent of aces, and percent of break points won.  It has negative coefficients for Australian Open, US Open, and Wimbledon compared to French Open and for percent of net points won.  There are no interaction effects in this model.


 For the significant variables ($\alpha$ = 95\%), after adjusting for the other variables, we expect percent of points won to be $`r signif(abs(coefs_n[2]), 2)` \pm `r signif(2 * sqrt(cov_n[2,2]), 2)`$ less at the Australian Open and $`r signif(abs(coefs_n[4]), 2)` \pm `r signif(2 * sqrt(cov_n[4,4]), 2)`$ less at Wimbledon compared to the French Open; to increase by $`r signif(abs(coefs_n[5]), 2)`\pm `r signif(2 * sqrt(cov_n[5,5]), 2)`$ for a one unit increase in opponent rank; a $`r .01 * signif(abs(coefs_n[7]), 2)`\pm `r signif(.02 * sqrt(cov_n[7,7]), 2)`$ increase for a .01 increase in percent of break points won; and to decrease by $`r .01 * signif(abs(coefs_n[8]), 2)` \pm `r signif(.02 * sqrt(cov_n[8,8]), 2)`$ for a .01 increase in percent of net points won.  As such, we see clear evidence Nadal performs better at the French Open compared to the other grand slams.


## Federer: Wimbledon extraordinaire: confirmed

```{r federer-model}

step_model_f <- courtsports:::model_individual(player_name = "Roger Federer", data = gs_partial_players, ref = "Wimbledon")

std_res_f <- rstandard(step_model_f)

gf <- ggplot(lm(step_model_f$formula, data = step_model_f$data)) + geom_hline(yintercept = 0, col = "red") +
  geom_point(aes(x=.fitted, y = .stdresid)) + my_theme + ylim(-3, 3) +
  labs(title = "Federer",
       x = "Predicted Percent of Points Won", y = "Standardized Residuals")


coefs_f <- coefficients(step_model_f)
cov_f <- vcov(step_model_f)
```


For Federer, the model with the lowest AIC has negative coefficients for Australian Open, French Open, and US Open vs Wimbledon, and W/UE,  It has positive coefficients for opponent rank, percent of break points won, and all the interaction terms: court and W/UE.

For the significant variables ($\alpha$ = 95\%), while adjusting for the other variables, we expect percent of points won to be $`r signif(abs(coefs_f[2] + coefs_f[8]), 2)` \pm `r signif(2 * sqrt(cov_f[2,2] + cov_f[8,8] + 2 * cov_f[2,8]), 2)`$ less at Australian Open compared to Wimbledon; $`r signif(abs(coefs_f[3] + coefs_f[9]), 2)`\pm `r signif(2 * sqrt(cov_f[3,3] + cov_f[9,9] + 2 * cov_f[3,9]), 2)`$ less at French Open compared to the Wimbledon; $`r signif(abs(coefs_f[4] + coefs_f[9]), 2)`\pm `r signif(2 * sqrt(cov_f[4,4] + cov_f[9,9] + 2 * cov_f[4,9]), 2)`$ less at US Open compared to Wimbledon;  to decrease by $`r signif(abs(coefs_f[6] + coefs_f[8]) , 2)` \pm `r signif(2 * sqrt(cov_f[6,6] + cov_f[8,8] + 2 * cov_f[6,8]), 2)`$ for a one unit increase in W/UE at Australian Open, $`r signif(abs(coefs_f[6] + coefs_f[9]) , 2)` \pm `r signif(2 * sqrt(cov_f[6,6] + cov_f[9,9] + 2 * cov_f[6,9]), 2)`$ for a one unit increase in W/UE at French Open, and $`r signif(abs(coefs_f[6] + coefs_f[10]) , 2)` \pm `r signif(2 * sqrt(cov_f[6,6] + cov_f[10,10] + 2 * cov_f[6,10]), 2)`$ for a one unit increase in W/UE at US Open.  This is strong evidence that Federer performs best at Wimbledon but possibly does better at the USO, depending on his W/UE ratio.


## Williams: hard court magician only: debunked


```{r williams-model}

step_model_w <- courtsports:::model_individual(player_name = "Serena Williams", data = gs_partial_players,
                                 start_lower = TRUE, ref = "Australian Open")

std_res_w <- rstandard(step_model_w)

gw <- ggplot(lm(step_model_w$formula, data = step_model_w$data)) + geom_hline(yintercept = 0, col = "red") +
  geom_point(aes(x=.fitted, y = .stdresid)) + my_theme + ylim(-3, 3) +
  labs(title = "Williams",
       x = "Predicted Percent of Points Won", y = "Standardized Residuals")

cov_w <- vcov(step_model_w)
coefs_w <- coefficients(step_model_w)
```

For Williams, the model with the lowest AIC selected 22 coefficients, which makes it the largest model of the three.  Since Williams only has 59 observations, we believe this model is overfitting and so caution the reader to be wary of any inference from this model.  It should also be noted that no women's point by point data was recorded for 2015 (in which she won three grand slams).

For the significant variables ($\alpha$ = 95$\%$), while adjusting for the other variables, we expect percent of points won to increase by $`r signif(abs(coefs_w[5]), 2)` \pm `r signif(2 * sqrt(cov_w[5,5]), 2)`$ for a 1 unit increase in opponent rank; to increase by $`r signif(abs(coefs_w[6] + coefs_w[11]) , 2)` \pm `r signif(2 * sqrt(cov_w[6,6] + cov_w[11,11] + 2 * cov_w[6,11]), 2)`$ for a one unit increase in W/UE at FO, to increase by  $`r signif(abs(coefs_w[6] + coefs_w[12]) , 2)` \pm `r signif(2 * sqrt(cov_w[6,6] + cov_w[12,12] + 2 * cov_w[6,12]), 2)`$ for a one unit increase in W/UE at USO, and to increase by  $`r signif(abs(coefs_w[6] + coefs_w[13]) , 2) `\pm `r signif(2 * sqrt(cov_w[6,6] + cov_w[13,13] + 2 * cov_w[6,13]), 2)`$ for a one unit increase in W/UE at Wi compared to AO; to increase by  $`r signif(.01 * abs(coefs_w[8] + coefs_w[17]) , 2)`\pm `r signif(.02 * sqrt(cov_w[8,8] + cov_w[17,17] + 2 * cov_w[17,8]), 2)`$ for a .01 increase in percent of aces at the FO; and to increase by $`r signif(.01 * abs(coefs_w[9] + coefs_w[20]) , 2)` \pm `r signif(.02 * sqrt(cov_w[9,9] + cov_w[20,20] + 2 * cov_w[20,9]), 2)`$ for a .01 increase in percent of break points won at the FO compared to AO.


Based on the model results, we do not see that Williams is dominant on the hard courts compared to the other courts.  Rather, she has respectable results on all the surfaces.  

# Discussion {#sec:discussion}

At the highest level, we find that the general point distribution seems to be the same for all court surfaces. There may be some differences in player performance on the different court surfaces, but these differences are not definitive (e.g. that Spaniards perform better on clay). We do not find evidence for a home court advantage across all players in the grand slams. We also find that the French Open seems to be the most different out of the four grand slams, but Wimbledon also displays some unique characteristics with regards to low amounts of UEs. 

Using a hierarchical model approach, we do not see strong individual effects for Williams, Federer, and Nadal in predicting wins. We do, however, see differences for these players in hierarchical models to predict aces, net winners, and unforced errors, and that these differences are largely consistent with common tennis knowledge.

Individual linear models predicting percent of points won show that Nadal is best on clay, Federer is best on grass, and Williams is strong in all grand slams, which also agrees with prior conceptions. 

Throughout our analyses, we often found that we are restricted by available data. Due to the large amount of grand slam data available, we are able to fit individual models for Federer, Nadal, and Williams that provided substantially more information about their performance on different court surfaces than the more general models which included all players. Point by point data from matches among lower-profile players is more likely to be missing or contain errors.  Ideally, these types of models would be possible for all players, not just the legends of the game. 

Looking forward, we would like to better explore the point by point data, especially for the attributes which excluded in this analysis: rally length, minutes played, and distance covered.  We would also like to pull in data from Masters level tournaments, which would give us a clearer view if the differences we found in this paper are due to court surface or the slam itself.  Another way we could adjust for grand slam confounders would be to incorporate weather conditions and matches played in the last few months.  Additionally, we would like to be able to adjust for performance over time as new competitors arrive and older players decline.


# References {#sec:refs}

\footnotesize
