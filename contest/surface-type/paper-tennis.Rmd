---
title: "Analyzing the Effect of Surface in Tennis Grand Slams"
author: "Kayla Frisoli, Shannon Gallagher, and Amanda Luby"
date: '`r format(Sys.time(), "%B %d, %Y")`'
output:
  pdf_document:
    fig_caption: yes
    keep_tex: yes
    number_sections: no
abstract: "Tennis grand slams consist of the Australian Open, French Open, Wimbledon, and US Open, which are played on hard (Plexicushion), clay, grass, and hard (DecoTurf) courts, respectively.  The surface type may substantially impact ball speed, height, and spin as well as player speed and agility.  It is also believed that play style and practice habits may contribute to different results across surface types.  For example, Rafael Nadal is thought to be the best clay court player of all time whereas Roger Federer is particularly known for dominance at Wimbledon.  On the women's side, Serena Williams once struggled on clay courts but has seemingly transformed her style to perform better on clay courts, but has perhaps suffered on grass as a consequence.  In this analysis, we examine the result of the top 100 players in grand slams from 2013-2017 across the four different surfaces.  We create a hierarchical model with fixed and random effects to predict the number of points won in a match.  We take into consideration player-specific effects, nationality (which is thought to have an effect on play style), sex, ranking, ELO, and game statistics.   We assess the fit of our model using standard statistical techniques (e.g. MSE, AIC, BIC, residual diagnostics) in addition to `common knowledge' factors (for instance, Rafael Nadal should be indicated as a superior clay court player by the model).  We compare the results of top 100 players across grand slams to examine the effect of court surface. We also provide an in-depth analysis of Nadal, Federer, and S. Williams."
bibliography: master.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(cache = TRUE)
library(deuce)
library(dplyr)
library(ggplot2)
library(forcats)
library(stringr)
library(knitr)
library(kableExtra)
```


```{r data-load, include = FALSE}
## Load WTA and ATP matches from deuce package
data(atp_matches)
data(wta_matches)
wta_matches$league <- "WTA"
atp_matches$league <- "ATP"

## Combining WTA and ATP
combined_tennis <- rbind(wta_matches, atp_matches)

## Subsetting from 2013 through 2017 inclusive, all the grand slams
gs <- combined_tennis %>% filter(tourney_level == "Grand Slams" & year >= 2013 & year <= 2017)
## Get rid of women's qualifiers
gs <- gs %>% filter(!(round %in% c("Q1", "Q2", "Q3", "Q4")))
dim(gs)

# saveRDS(gs, "../../data/gs_2013_2017.rda")

```

```{r data-cleaning, include = FALSE}
## Add new columns of winner points won, loser points won, and whether the winner had more points
gs <- gs %>% mutate(w_pointswon = w_1stWon + w_2ndWon + l_svpt - l_1stWon - l_2ndWon,
                    l_pointswon = l_1stWon + l_2ndWon + w_svpt - w_1stWon - w_2ndWon)

## Extract number of sets in each match
no_ret <- gsub(" RET", "", gs$score)
set_scores <- str_split(no_ret, " ")
n_sets <- sapply(set_scores, length)
gs$n_sets <- n_sets

## Data cleaning the tournament names
gs$tournament <- factor(gs$tourney_name)
gs$tournament <- gs$tournament %>% fct_collapse("US Open" = c("US Open", "Us Open"), 
                                                "French Open" = c("French Open", "Roland Garros"))
```

```{r games-won, include = FALSE, warning = FALSE}
## Extract games won for winner and loser
score_list <- strsplit(gs$score, " ")
games_won <- sapply(score_list, strsplit, split = "-|\\(")
gs$w_gameswon <- sapply(games_won, function(list){
  sum(as.integer(sapply(list, "[", 1)), na.rm = TRUE)
})
gs$l_gameswon <- sapply(games_won, function(list){
  sum(as.integer(sapply(list, "[", 2)), na.rm = TRUE)
})

```

```{r sets, include = FALSE, warning = FALSE}
## Extract number of sets for each match
no_ret <- gsub(" RET", "", gs$score)
set_scores <- str_split(no_ret, " ")
n_sets <- sapply(set_scores, length)
gs$n_sets <- n_sets

```

```{r bp-lost, include = FALSE}
gs$w_bplost <- gs$w_bpFaced - gs$w_bpSaved
gs$l_bplost <- gs$l_bpFaced - gs$l_bpSaved
```


```{r}
remove_from_loser <- names(gs)[grep("^w|^W", names(gs))] %>%
  .[-which(. == "winner_rank")]

remove_from_winner <- names(gs)[grep("^l|^L", names(gs))] %>%
  .[-which(. %in% c("loser_rank", "league"))]

gs_l <- dplyr::select(gs, -remove_from_loser) %>%
  rename(opponent_rank = winner_rank)
gs_w <- dplyr::select(gs, -remove_from_winner)  %>%
  rename(opponent_rank = loser_rank)

names(gs_w) <- gsub("^winner_|^W|^w_", "", names(gs_w))
names(gs_l) <- gsub("^loser_|^L|^l_", "", names(gs_l))

player_gs <- bind_rows(gs_w, gs_l)

# saveRDS(player_gs, "../../data/player_gs.rda")
```

## Introduction
Example reference[@cdc-measles2018]

## Data
The data consists of `r nrow(gs)` matches split evenly over the four grand slams and the two leagues (ATP and WTA).  Each match has `r ncol(gs)` attributes, many of which are redundant.  We focus on the following attributes for both the winner and loser of the match: games won, points won, retirement, break points faced, break points saved, aces, country of origin, and player attributes.  Additionally, we take into account the number of sets in a match, the surface type, minutes played, and round of the tournament.  A subset of the data is shown in Table \ref{tab:data}.

```{r tab-data, include = TRUE, echo = FALSE}
set.seed(19)
s_id <- which(gs$winner_name %in% c("Serena Williams", "Roger Federer", "Rafael Nadal"))
rand_inds <- sample(s_id, 5)
cols <- c("tourney_name", "year", "winner_ioc", "w_pointswon", "winner_name", "winner_rank", "l_pointswon", "loser_name")
knitr::kable(gs[rand_inds, cols], format = "latex",
             row.names = FALSE, col.names = c("Tournament", "Year", "W. Country", "W. Points", "Winner", "W. Rank", "L. Points", "Loser"),
             caption = "\\label{tab:data}Example of the grand slam data.  It includes winner and loser attributes, match attributes, and tournament attributes.  Not all attributes are shown here.",
             booktabs = TRUE) %>% kable_styling(latex_options = "striped")
```

## Methods

## Results

## Discussion

## References
