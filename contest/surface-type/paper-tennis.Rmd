---
title: "Analyzing the Effect of Surface in Tennis Grand Slams"
author: "Kayla Frisoli, Shannon Gallagher, and Amanda Luby"
date: '`r format(Sys.time(), "%B %d, %Y")`'
output:
  pdf_document:
    fig_caption: yes
    keep_tex: yes
    number_sections: yes
header-includes:
  - \usepackage{hyperref}
abstract: "Tennis grand slams consist of the Australian Open, French Open, Wimbledon, and US Open, which are played on hard (Plexicushion), clay, grass, and hard (DecoTurf) courts, respectively.  The surface type may substantially impact ball speed, height, and spin as well as player speed and agility.  It is also believed that play style and practice habits may contribute to different results across surface types.  For example, Rafael Nadal is thought to be the best clay court player of all time whereas Roger Federer is particularly known for dominance at Wimbledon.  On the women's side, Serena Williams once struggled on clay courts but has seemingly transformed her style to perform better on clay courts, but has perhaps suffered on grass as a consequence.  In this analysis, we examine the result of the top 100 players in grand slams from 2013-2017 across the four different surfaces.  We create a hierarchical model with fixed and random effects to predict the number of points won in a match.  We take into consideration player-specific effects, nationality (which is thought to have an effect on play style), sex, ranking, ELO, and game statistics.   We assess the fit of our model using standard statistical techniques (e.g. MSE, AIC, BIC, residual diagnostics) in addition to `common knowledge' factors (for instance, Rafael Nadal should be indicated as a superior clay court player by the model).  We compare the results of top 100 players across grand slams to examine the effect of court surface. We also provide an in-depth analysis of Nadal, Federer, and S. Williams."
bibliography: master.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(warning=FALSE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(cache = TRUE)
library(deuce)
library(dplyr)
library(tidyr)
library(ggplot2)
library(forcats)
library(stringr)
library(knitr)
library(kableExtra)
library(gridExtra)
library(grid)
library(MASS)
## To change into library(courtsports)
devtools::load_all("../..")

```


```{r data-cleaning, include = FALSE}
data(gs)
data(gs_players)
data(gs_partial)
data(gs_partial_players)

```

```{r graphing-parameters, include = FALSE}
my_theme <-  theme_bw() + # White background, black and white theme
  theme(axis.text = element_text(size = 12),
        text = element_text(size = 14,
        family="serif"),
        plot.title = element_text(hjust = 0.5, size=16))

tournament_colors <- c("#0297DB", "#b06835", "#0C2340", "#54008b")
league_colors <- c("#0C2340", "#902BA3")
win_colors <- c("#336699", "#339966")
```


# Introduction {#sec:iintro}
Rafael Nadal is known as the "King of Clay" in tennis, having won 11 out of his current 17 grand slams titles at the French Open, which is played on a clay surface [@bbc2018].  In contrast, his rival Roger Federer has won his most grand slam titles (8 out of 20) at Wimbledon, which is played on grass.  On the women's side, Serena Williams, winner of 24 grand slam titles, has been dominant both on hard court (7 titles at the Australian Open and 6 at US Open) and grass (7 at Wimbledon).  This trend extends to other top players, who seem to have better results at some grand slams than others.  More broadly, it seems that country of origin has an interaction effect with court type.  For example, Spanish players seem to excel on clay courts and Americans have great success at Wimbledon despite grass courts not being of wide use in the USA.  It also worth questioning whether the US Open and Australian Open should be grouped together as hard courts despite having different surface compositions [@theage2007].  In this paper, we analyze the results of grand slam players from 2013-2017,  and we 

1. Determine if and how court surface effects players by implementation of a series of nested hierarchical models

2. Examine how Nadal, Federer, and Williams' play differs by surface

3. Assess whether we can group the two hard court surfaces together.

As to issue (1) quantifying the effect of court surface on players, there has not been much written about with regards to tennis.  There are materials available in the literature for forecasting the outcome of tennis matches [@klaassen2003; @newton2005; @mchale2011; @kovalchik2016]] or for assessing whether points within a match are independent and identically distributed [@klaassen2001].   [@knottenbelt2012] do take into account surface in their model but do not compare the results of one surface to another.  Other sports analyses do take into account surface type such as grass vs. turf in soccer and football.  Results from these studies show that surface type does have an effect on the game, either directly or indirectly [@andersson2008; @gains2010;].

We use models that take into account both individual and group effects such as in the Gaussian-process player production basketball model or predicting individual soccer performance  [@page2013; @egidi2018].  Both of those models had success using hierarchical Bayesian models, which we employ in our own models. More specifically, we model the players' expected points in a match based on the player's own characteristics, the court/tournament effects, and the opponent's ranking.


For issue (2) the player analysis of Nadal, Federer, and Williams, we examine whether our model passes the "common sense" tests  like how the models in [@thomas2013] show that commonly well known hockey players also have high status in the model.  We also examine whether these players do have surface apparent effects. Few academic papers have been written about Nadal, Federer, or Williams.  One paper studies Federer's odds of winning when Nadal suddenly withdrew from Wimbledon showed that Federer was too heavily favored by bookmakers [@leitner2009].  One analysis of Williams shows how she has gotten better with age, even past the point when other greats began to decline, but the study does not look at surface type [@five2015].

Finally, for issue (3), we use clustering methods in order to determine which court surface types are more similar to one another.

Readers may object that we are looking at differences between grand slams, which each have their own time period, weather conditions, play time conditions, and "home court effects" instead of differences in surfaces alone.  However, (1) grand slam data is the most readily available and most complete which makes it the best choice at the moment for modelling, (2) we adjust for these confounders where we can, and (3) analyzing the difference in the grand slams is still useful as they are considered to be the most prestigious events in tennis.

The rest of this paper is organized as follows. In [Section Data](#sec:data) we describe our grand slam tennis data.  In [Section Early Data Analysis](#sec:eda) we examine the data at a high level and use clustering whether to determine how the courts differ from one another.  In [Section Methods](#sec:methods) we describe our hierarchical models we use to determine difference in court surfaces.  In [Section Results](#sec:results) we describe the results of our modelling and also examine the play of Nadal, Federer, and Williams.  Finally in [Section Discussion](#discussion), we discuss future work and extensions or our model. 



# Data and EDA {#sec:data-eda}

## Data {#sec:data}
The data consists of `r nrow(gs)` matches split evenly over the four grand slams and the two leagues: ATP (men's) and WTA (women's).  Each match has `r ncol(gs)` attributes, many of which are redundant.  We focus on the following attributes for both the winner and loser of the match: games won, points won, retirement, break points faced, break points saved, aces, country of origin, and player attributes.  Additionally, we take into account the number of sets in a match, the surface type, and round of the tournament.  A subset of the data is shown in Table \ref{tab:data}.



```{r tab-data, include = TRUE, echo = FALSE}
w_id <- which(gs$winner_name == "Serena Williams")[1:2]
f_id <- which(gs$winner_name == "Roger Federer")[1:2]
n_id <- which(gs$winner_name == "Rafael Nadal")[1:2]
s_id <- which(gs$winner_name %in% c("Serena Williams", "Roger Federer", "Rafael Nadal"))
cols <- c("winner_name", "tourney_name", "year", "winner_ioc", "w_pointswon", "winner_rank", "l_pointswon", "loser_rank")
knitr::kable(gs[c(w_id, f_id, n_id), cols], format = "latex",
             row.names = FALSE, col.names = c("Winner", "Tournament", "Year", "W. IOC", "W. Points",  "W. Rank", "L. Points", "L. Rank"),
             caption = "\\label{tab:data}Example of the grand slam data.  It includes winner and loser attributes, match attributes, and tournament attributes.  Not all attributes are shown here.",
             booktabs = TRUE) %>% kable_styling(latex_options = "striped")
```

The data is obtained from Jeff Sackmann's open website via the `R` package `deuce` [@sackmann2018; @deuce2017].  All steps of our analysis from collection to dissemination are freely available online.

## Early Data Analysis {#sec:eda}

### Examining the distribution of points earned

We first examine the distribution of points earned per match. We find that the distribution is similar across tournament, with Wimbledon differing slightly from the other grand slams. As expected, there are more points earned in the WTA than the ATP due to the differing numbers of games played. Also unsurprisingly, the winners of the match tended to earn more points than the losers.   

```{r, fig.height=5, fig.width=12}

# grid.arrange(p1, p2, p3, ncol=3, widths=c(.25, .41, .34))


p2 <- ggplot(gs_players) + geom_density(aes(pointswon, color = tournament)) + 
  labs(x = "Points") + my_theme +
  scale_color_manual("Tournament", values=tournament_colors)

p3 <- ggplot(gs_players) + geom_density(aes(pointswon, color = league))+ 
  labs(x = "Points") +
  scale_color_manual("League", values=league_colors) +
  my_theme


# grid.arrange( p2, p3, ncol=2,
#              top = textGrob("Winning points by tournament and league",
#                             gp=gpar(fontsize=20)))

p1 <- ggplot(gs_players) + geom_density(aes(pointswon, color = factor(did_win))) + 
  labs(x = "Points") +
  scale_color_manual("Winner?", values=win_colors) +
  my_theme +
  facet_wrap(~league, ncol=1)

grid.arrange(p1, p2, ncol=2,
             top = textGrob("Distribution of points per match",
                            gp=gpar(fontsize=20, fontfamily="serif")),
              layout_matrix = rbind(c(NA, 1),
                                    c(2, 1),
                                    c(NA, 1)),
             heights=c(1, 3, 1))

```


### Home court advantage 

It is commonly thought that there is a home court advantage in grand slam games (SOURCE). In our data we find this to be true (i.e. French players win the French open more than French players win other slams). But, we also know that the home team is given preference for wild card bids (SOURCE) so potentially citizens of a particular country play in "their" tournament more often than they play in other tournaments. We also find this to be true in our data for France, The United States, and Australia (i.e. the proportion of French players in the French Open is greater than the proportion of French players in other slams). 

Therefore, we want to see how the proportion of wins for the home country changes across the different tournaments. If there was really a home court advantage, the proportion of French wins each round would be higher at the French Open than the Australian Open, the US Open, and Wimbledon. The same would be true for Australia and the US. But, we see that this isn't the case. After accounting for the number of players from each country, we don't find a home court advantage in the grand slam. 

```{r, fig.height=4, fig.width=12}
france_wins <- filter(gs_players, ioc == "FRA", round < "QF") %>% 
  group_by(tournament, round) %>% 
  summarise(win_prop = mean(did_win),
            win_prop_se = sqrt(win_prop*(1-win_prop)/n()))

us_wins <- filter(gs_players, ioc == "USA", round < "QF") %>% 
  group_by(tournament, round) %>% 
  summarise(win_prop = mean(did_win),
            win_prop_se = sqrt(win_prop*(1-win_prop)/n()))

aus_wins <- filter(gs_players, ioc == "AUS", round < "QF") %>% 
  group_by(tournament, round) %>% 
  summarise(win_prop = mean(did_win),
            win_prop_se = sqrt(win_prop*(1-win_prop)/n()))

p1<- ggplot(france_wins, aes(round, win_prop, color=tournament, group=tournament)) + 
  geom_line() + 
  # geom_point() +
  labs(title = "French players",
       x = "", y = "Win proportion") + 
  scale_color_manual(guide=FALSE, values=tournament_colors) + my_theme

p2 <- ggplot(us_wins, aes(round, win_prop, color=tournament, group=tournament)) + 
  geom_line() + 
  # geom_point() +
  labs(title = "American players",
       x = "", y = "Win proportion") +  
  scale_color_manual(guide=FALSE, values=tournament_colors)  + my_theme

p3 <- ggplot(aus_wins, aes(round, win_prop, color=tournament, group=tournament)) + 
  geom_line() + 
  # geom_point() +
  labs(title = "Australian players",
       x = "", y = "Win proportion") + 
  scale_color_manual(" ", values=tournament_colors) + my_theme

grid.arrange(p1,p2, p3, nrow=1, widths = c(.29, .29, .42),
             top = textGrob("Home court advantage debunked: win proportion by country",
                            gp=gpar(fontsize=20, fontfamily="serif")),
             bottom = textGrob("Note: we only look at the first 4 rounds due to decreasing sample size as the tournament goes on",
                           # x = 0,
                           # y = 0.5,
                           just = "left"))

```


## Spaniards on clay

It is also commonly thought that Spaniards play better on clay. We are interested in whether Spaniards win the French Open more than they win in other tournaments. It does appear that Spaniards are winning the French Open more than they are winning other tournaments. But, this result is not significant. In addition, the ranking of Spaniards in the French Open is, on average, higher than other tournaments, which may help explain this common misconception, although this result is not significant either. 

```{r, fig.height=5, fig.width=12}

spain_wins <- filter(gs_players, ioc == "ESP", round < "QF") %>% 
  group_by(tournament, round) %>% 
  summarise(win_prop = mean(did_win),
            win_prop_se = sqrt(win_prop*(1-win_prop)/n()),
            avg_ranking = mean(rank),
            rank_se = sd(rank)/sqrt(n()))

p1 <- ggplot(spain_wins, aes(round, win_prop, color=tournament, group=tournament)) + 
  geom_line() + 
  labs(title = "Win proportion among Spaniards",
       # caption = "Note: we only look at the first 4 rounds due to decreasing sample size",
       x = "", y = "Win proportion") + 
  scale_color_manual(guide=FALSE, values=tournament_colors) + my_theme  
  # geom_point() + 
  # labs(title = "Proportion of wins among Spaniards") +
  # geom_errorbar(aes(ymin = win_prop - win_prop_se,
  #                   ymax = win_prop + win_prop_se),
  #               width=.2,
  #                position=position_dodge(0.05))

p2 <- ggplot(spain_wins, aes(round, avg_ranking, color=tournament, group=tournament)) + 
  geom_line() + 
  labs(title = "Average ranking among Spaniards",
       x = " ",
       y = "Average rank") + 
  scale_color_manual(" ", values=tournament_colors) + my_theme 
# +
#   geom_errorbar(aes(ymin = avg_ranking - 1.96*rank_se,
#                     ymax = avg_ranking + 1.96*rank_se),
#                 width=.2,
#                  position=position_dodge(0.05))

grid.arrange(p1,p2, nrow=1, widths = c(.44, .56),
             top = textGrob("Spaniards perform better on Clay: debunked",
                            gp=gpar(fontsize=20)),
             bottom = textGrob("Note: we only look at the first 4 rounds due to decreasing sample size",
                           # x = 0,
                           # y = 0.5,
                           just = "left",
                           gp=gpar(fontfamily="serif")))

```

# Methods {#sec:methods}



## Examining individual players
```{r table}
data(gs_partial_players)

top_three <- dplyr::filter(gs_players, name %in% c("Rafael Nadal", "Roger Federer", "Serena Williams"))
matches_played_slam_year <- top_three %>% group_by(name, tournament, year) %>%
  summarize(matches_played = n())
matches_played_slam <- matches_played_slam_year %>% group_by(name, tournament) %>%
  summarize(matches_played = sum(matches_played))
tab <- spread(matches_played_slam, key = name, value = matches_played)
total_df <- data.frame(tournament = "Total", as.list(colSums(tab[,-1])))
colnames(total_df) <- colnames(tab)
tab <- rbind(tab, total_df)

knitr::kable(tab, format = "latex",
               row.names = FALSE, col.names = c("Tournament", "Nadal", "Federer", "Williams"),
               caption = "\\label{tab:three-gs-counts}Number of matches played for Nadal, Federer, and Williams from 2013-2017 at each of the grand slams.",
               booktabs = TRUE) %>% kable_styling(latex_options = "striped") %>%
    row_spec(5, bold = TRUE, background = "lightgray")
```

In Table \ref{tab:three-gs-counts}, we display the number of matches Nadal, Federer, and Williams have played from 2013-2017.  Over that time span, Nadal won 6 grand slams, Federer won 1, Williams won 8.  Despite this, Federer played more total matches in Nadal.  All three players were absent for exactly three slams during this time period due to external factors (Nadal: (1 AO, 0 FO, 1 Wim, 1 USO), Federer: (0 AO, 2 FO, 0 Wim, 1 USO), Serena: (0 AO, 1 FO, 1 Wim, 1 USO)).  Not unexpectedly, Nadal has the most wins on clay (`r tab[2, 2]`), Federer has the most wins at Wimbledon (`r tab[4, 3]`) and Williams the most on hardcourt (`r tab[1, 4]` at AO and `r tab[4, 4]` at USO).  Despite having played more matches than Nadal, Federer only has 1 grand slam to show compared to Nadal's six, which indicates that Federer made it deeper into tournaments on average but had difficulties winning the championships.  For the WTA, Williams had her second most successful five-year span at the grand slams over this time period, winning 8.

We fit individual models for these three individuals (subsetting the data to their matches only), estimating the percent of points won in a match using stepwise regression.  The lower model is the  percent of points regressed on the opponent rank and indicator variables for court type with the FO as the reference variable.  The upper model is the lower model with the additional variables of winner to unforced error ratio, average serve speed, percent aces, percent break points, percent net points won, and their interaction effects with court type.  We do not display the full best fit models here, but they are available online.

ADD CIS!!

## Nadal



```{r nadal-model}

step_model_n <- model_individual(player_name = "Rafael Nadal", data = gs_partial_players)

std_res_n <- rstandard(step_model_n)

gn <- ggplot(lm(step_model_n$formula, data = step_model_n$data)) + geom_hline(yintercept = 0, col = "red") +
  geom_point(aes(x=.fitted, y = .stdresid)) + my_theme + ylim(-3, 3) +
  labs(title = "Nadal",
       x = "Predicted Percent of Points Won", y = "Standardized Residuals")


coefs_n <- coefficients(step_model_n)
```


Looking at Nadal individually, the model with the lowest AIC has positive coefficients opponent rank, percent of aces, and percent of break points won.  It has negative coefficients for AO, USO, and Wim. compared to FO and for percent of net points won.  There are no interaction effects in this model.


The standardized residuals plot shown in Figure \ref{fig:individ-resids} (along with the other linear regression diagnostics plots not shown here) shows that the model is a good fit for predicting the percent of points won.  For the significant variables ($\alpha$ = 95\%), while adjusting for the other variables, we expect percent of points won to be $`r signif(abs(coefs_n[2]), 2)`$ less at the AO and $`r signif(abs(coefs_n[4]), 2)`$ less at Wim compared to the FO; to increase by $`r signif(abs(coefs_n[5]), 2)`$ for a one unit increase in opponent rank; a `r .01 * signif(abs(coefs_n[7]), 2)`\% increase for a .01 increase in percent of break points won; and to decrease by $`r .01 * signif(abs(coefs_n[8]), 2)`$ for a .01 increase in percent of net points won.  As such, we see clear evidence Nadal performs better at the FO compared to the other grand slams.

## Federer
```{r federer-model}

step_model_f <- model_individual(player_name = "Roger Federer", data = gs_partial_players, ref = "Wimbledon")

std_res_f <- rstandard(step_model_f)

gf <- ggplot(lm(step_model_f$formula, data = step_model_f$data)) + geom_hline(yintercept = 0, col = "red") +
  geom_point(aes(x=.fitted, y = .stdresid)) + my_theme + ylim(-3, 3) +
  labs(title = "Federer",
       x = "Predicted Percent of Points Won", y = "Standardized Residuals")

coefs_f <- coefficients(step_model_f)
```


For Federer, the model with the lowest AIC has negative coefficients AO, FO, and USO. vs Wim., and W/UE,  It has positive coefficients for opponent rank, percent of break points won, and all the interaction terms: court and W/UE.

The standardized residuals plot shown in Figure \ref{fig:individ-resids}  shows that the model is a fair fit for predicting the percent of points won, but almost seem to see two clusters of residuals splitting with predicted point percentage of about 0.63.  For the significant variabless ($\alpha$ = 95\%), while adjusting for the other variables, we expect percent of points won to be $`r signif(abs(coefs_f[2] + coefs_f[8]), 2)`$ less at AO compared to the Wim.; $`r signif(abs(coefs_f[3] + coefs_f[9]), 2)`$ less at FO compared to the Wim.; $`r signif(abs(coefs_f[4] + coefs_f[9]), 2)`$\% less at USO compared to the Wim.;  to decrease by $`r signif(abs(coefs_f[6] + coefs_f[8]) , 2)`$ for a one unit increase in W/UE at AO, $`r signif(abs(coefs_f[6] + coefs_f[9]) , 2)`$ for a one unit increase in W/UE at FO, and $`r signif(abs(coefs_f[6] + coefs_f[10]) , 2)`$ for a one unit increase in W/UE at USO.  It is clear that Federer performs best at Wimbledon.

## Williams
```{r williams-model}

step_model_w <- model_individual(player_name = "Serena Williams", data = gs_partial_players,
                                 start_lower = TRUE, ref = "Australian Open")

std_res_w <- rstandard(step_model_w)

gw <- ggplot(lm(step_model_w$formula, data = step_model_w$data)) + geom_hline(yintercept = 0, col = "red") +
  geom_point(aes(x=.fitted, y = .stdresid)) + my_theme + ylim(-3, 3) +
  labs(title = "Williams",
       x = "Predicted Percent of Points Won", y = "Standardized Residuals")

coefs_w <- coefficients(step_model_w)
```


```{r resid plots,  fig.height=4, fig.width=12, fig.cap = "\\label{fig:individ-resids}Standardized residuals vs percent of points won  best fit model from forward-backwards stepwise regression for Nadal's, Federer's, and William's, respectively.}"}

grid.arrange(gn, gf, gw, ncol = 3, 
              top = textGrob("Standardized Residuals vs. Predicted % Points Won",
                            gp=gpar(fontsize=20, fontfamily="serif")))


```

For Williams, the model with the lowest AIC is the largest model of the three selected 22 coefficients.  Since Williams only has 59 observations, we believe this model is overfitting and so caution against inference with this model.  It should also be noted that no women's point by point data was recorded for 2015 so that year is excluded from this model.  The coefficients are court, opponent rank, W/UE, average serve speed, percent aces, percent break points won, percent net points won, and interaction effects with court and W/UE, court and average service speed, court and percent aces, and court and break points won.

The standardized residuals plot shown in Figure \ref{fig:individ-resids}  shows that the model is a fair fit for predicting the percent of points won, but we tend to overestimate the percent of points won in comparison with Nadal.   For the significant variables ($\alpha$ = 95\%), while adjusting for the other variables, we expect percent of points won to increase by $`r signif(abs(coefs_w[5]), 2)`$ for a 1 unit increase in oponent rank; to increase by $`r signif(abs(coefs_w[6] + coefs_w[11]) , 2)`$ for a one unit increase in W/UE at FO, to increase by  $`r signif(abs(coefs_w[6] + coefs_w[12]) , 2)`$for a one unit increase in W/UE at USO, and to increase by  $`r signif(abs(coefs_w[6] + coefs_w[13]) , 2)`$ for a one unit increase in W/UE at Wim. compared to AO; to increase by  $`r signif(.01 * abs(coefs_w[8] + coefs_w[17]) , 2)`$ for a .01 increase in percent of aces at the French Open; and to increase by $`r signif(.01 * abs(coefs_w[9] + coefs_w[20]) , 2)`$ for a .01 increase in percent of break points won at the French Open.

For this, we do not see that Williams is dominant on the hard courts compared to the other courts.  Rather, she has good results on all the courts.  Her significant interaction effects show that if she focuses on acing her opponent and capitalizing on breakpoints, then she has a better chance at winning more points than at the Australian Open.

# Discussion {#sec:discussion}

# References {#sec:refs}

\footnotesize
