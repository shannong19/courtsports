---
title: "Opening up the court (surface) in tennis grand slams"
date: '`r format(Sys.time(), "%B %d, %Y")`'
output:
  pdf_document:
    fig_caption: yes
    keep_tex: yes
    number_sections: yes
header-includes:
  - \usepackage{hyperref}
abstract: "IDK writing is hard"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(warning=FALSE)
knitr::opts_chunk$set(message = FALSE)
library(deuce)
library(dplyr)
library(tidyr)
library(ggplot2)
library(forcats)
library(stringr)
library(knitr)
library(kableExtra)
library(gridExtra)
library(grid)
library(MASS)
library(ggrepel)
library(broom)
library(lme4)
library(cowplot)
library(ggpubr)


## To change into library(courtsports)
devtools::load_all("../..")

```


```{r data-cleaning, include = FALSE}
data(gs)
data(gs_players)
data(gs_partial)
data(gs_partial_players)
```

```{r graphing-parameters, include = FALSE}
my_theme <-  theme_bw() + # White background, black and white theme
  theme(axis.text = element_text(size = 12),
        text = element_text(size = 14,
        family="serif"),
        plot.title = element_text(hjust = 0.5, size=16))

tournament_colors <- c("#0297DB", "#b06835", "#0C2340", "#54008b")
league_colors <- c("#0C2340", "#902BA3")
win_colors <- c("#336699", "#339966")

# with yellow for us
tournament_colors <- c("#0297DB", "#b06835", "#ffe500", "#54008b")

```


```{r modelling, eval = FALSE}
## HIERARCHICAL MODELLING
## NOT RUN
## WARNING: Takes about 1 HOUR

gs_players$name_int = as.integer(as.factor(gs_players$name))
gs_players$hand_fac = as.factor(gs_players$hand)
gs_players$ioc_fac = as.factor(gs_players$ioc)
gs_players$atp = gs_players$league == "ATP"
gs_players$year_fac = as.factor(gs_players$year)
gs_players$late_round = gs_players$round >= "R16"
gs_players$seeded = gs_players$rank <= 32
gs_players$opponent_seeded = gs_players$opponent_rank <= 32

set.seed(091418)
nocourt_logistic = glm(did_win ~ ioc_fac + late_round + log(rank) + log(opponent_rank) + year_fac + atp, data = gs_players, family = "binomial")
base_logistic = glm(did_win ~ ioc_fac +  tournament + late_round + log(rank) + log(opponent_rank) + year_fac + atp, data = gs_players, family = "binomial")
country_logistic = glmer(did_win ~ late_round + log(rank) + log(opponent_rank) + year_fac + atp + (0 + tournament |ioc_fac), data = gs_players, family = "binomial")
ind_logistic = glmer(did_win ~  ioc_fac + late_round + log(rank) + log(opponent_rank) + year_fac + atp + (0 + tournament |name_int), data = gs_players, family = "binomial")
ind_logistic_noioc = glmer(did_win ~ late_round + log(rank) + log(opponent_rank) + year_fac + atp + (0 + tournament |name_int), data = gs_players, family = "binomial")
ind_int_logistic = glmer(did_win ~ late_round + log(rank) + log(opponent_rank) + year_fac + atp + tournament + (1|name_int), data = gs_players, family = "binomial")
ind_year_logistic = glmer(did_win ~ late_round + log(rank) + log(opponent_rank) + atp + tournament + (0+year_fac|name_int), data = gs_players, family = "binomial")
n_aces_mod = lmer(n_aces ~ late_round + log(rank) + log(opponent_rank) + year_fac + atp + (0 + tournament |name), data = gs_partial_players)
n_winners_mod = lmer(n_winners ~ late_round + log(rank) + log(opponent_rank) + year_fac + atp + (0 + tournament |name), data = gs_partial_players)
n_net_mod = lmer(n_netpt_w ~ late_round + log(rank) + log(opponent_rank) + year_fac + atp + (0 + tournament |name), data = gs_partial_players)
n_ue_mod = lmer(n_ue ~ late_round + log(rank) + log(opponent_rank) + year_fac + atp + (0 + tournament |name), data = gs_partial_players)


```


# Introduction {#sec:intro}

Rafael Nadal is known as the "King of Clay" in tennis, having won 11 out of his current 17 grand slams titles at the French Open (FO), which is played on a clay surface [@bbc2018].  In contrast, his rival Roger Federer has won his most grand slam titles (8 out of 20) at Wimbledon (Wim.), which is played on grass.  On the women's side, Serena Williams, winner of 24 grand slam titles, has been dominant both on hard court (7 titles at the Australian Open (AO) and 6 at US Open (USO)) and grass (7 at Wim.).  These three players have different playstyles and origins, and they are legends in the sport of tennis.  However, their success at grand slams seems to differ among the tournaments, which leads to question why that may be the case.

The four grand slams (AO, FO, Wim., USO) are played in different cities (Melbourne, Paris, London, New York City) at different starting dates (January, May, June, August) over the course of two weeks with 7 total rounds and 128 players.  As a feature unique to tennis, all four slams are played on different surfaces (Plexicushion hardcourt, clay, grass, DecoTurf hardcourt).  It is often thought that top players achieve better results on some surfaces than others.  For example, there is the "home court advantage:" do players from the country of the grand slam tournament perform better than at other grand slams?  Recently, Spanish players, led by Nadal, seem to have dominated the clay court scene [@tp2018] making it seem like players of a certain country may perform better on some surfaces than others.

 In this paper, we analyze the results of grand slam players from 2013-2017, and we analyze the surface effect on players at the four grand slams, first broadly at a high level and then narrowing down to player effects.  More specifically,

1. Determine if results in terms of wins/losses and point distribution differ across the four surfaces

2. Examine more fine grained attributes such as winners, aces, and unforced errors across the four surfaces

3. Assess how individuals differ across the four surfaces, with special focus on Nadal, Federer, and Williams.

As to issue (1) quantifying the high-level effect of court surface on players, there has not been much written about with regards to tennis.  There are materials available in the literature for forecasting the outcome of tennis matches [@klaassen2003; @newton2005; @mchale2011; @kovalchik2016]] or for assessing whether points within a match are independent and identically distributed [@klaassen2001].   [@knottenbelt2012] do take into account surface in their model but do not compare the results of one surface to another and [@pollard2007] concludes that players have more injuries on grass comparead to other courts.  Other sports analyses do take into account surface type such as grass vs. turf in soccer and football.  Results from these studies show that surface type does have an effect on the game, either directly or indirectly [@andersson2008; @gains2010;].

For issue (2) we examine the match attributes more unique to tennis such as winners (when a player hits a shot that the opponent is unable to return), aces (a serve an opponent is unable to return), and unforced errors (UE) (when a player makes a simple mistake resulting in a loss of the point).  Specifically, serving is thought to be of greater importance at Wimbledon since the ball travels faster on grass.  In general, players hope to maximize the winner to UE ratio (W/UE), which may lead to playing more aggressively on faster courts and more conservatively on slower courts such as clay [@theage2007].


Finally, for issue (3) the player analyses, we take two approaches.  On one hand, we use a hierarchical model with fixed and random effects taking into account player and tournament attributes using the complete data set and to fairly compare players to one another.  This allows us to leverage tournament information to players without many matches played and to help account for noise.  On the other hand, since Nadal, Federer, and Williams are extremely popular and have had much success in the 2013-2017 time range, we have enough data points with feature attributes to examine the effects individually.  In both cases, we examine whether our models pass "common sense" tests like how the models in [@thomas2013] show that commonly well known hockey players also have high status in the model.  We also examine whether these players do have surface apparent effects.

We use models that take into account both individual and group effects such as in the Gaussian-process player production basketball model or predicting individual soccer performance  [@page2013; @egidi2018].  For our hierarchical model across all players, we model whether a player or lost a match based on player attributes along with opponent rank.  For the individual models, we instead model percent of points won which can better show how dominant a player is in a match.  For model selection, we use AIC to compare models from one another [@wasserman2004].  For the individual models, we do not split the data into training and test sets due to the relatively low number of observations for the individuals.  However, when the data becomes available, we would like to test these models on the 2018 grand slam results.


Few academic papers have been written about Nadal, Federer, or Williams.  One paper studies Federer's odds of winning when Nadal suddenly withdrew from Wimbledon and shows that Federer was too heavily favored by bookmakers [@leitner2009].  One analysis of Williams shows how she has gotten better with age, even past the point when other greats began to decline, but the study does not look at surface type [@five2015].


Readers may object that we are looking at differences between grand slams, which each have their own time period, weather conditions, play time conditions, and "home court effects" instead of differences in surfaces alone.  However, (1) grand slam data is the most readily available and most complete which makes it the best choice at the moment for modelling, (2) we adjust for these confounders where we can, and (3) analyzing the difference in the grand slams is still useful as they are considered to be the most prestigious events in tennis.

The rest of this paper is organized as follows. In [Section Data](#sec:data) we describe our grand slam tennis data.  In [Section Early Data Analysis](#sec:eda) we examine the data at a high level and use clustering whether to determine how the courts differ from one another.  In [Section Methods](#sec:methods) we describe our models with (1) complete data with few features and (2) partial data with more features.  In [Section Results](#sec:results) we describe the results of our modelling and also examine the play of Nadal, Federer, and Williams.  Finally in [Section Discussion](#discussion), we discuss future work and extensions or our models. 



# Data and EDA {#sec:data-eda}

## Data {#sec:data}

The primary data consists of `r nrow(gs)` matches split evenly over the four grand slams and the two leagues: ATP (men's) and WTA (women's).  There are 5080 observations in this data set, which corresponds to a complete data set for the period of 2013-2017 for four grand slams, two, leagues, and 7 rounds.  Each match has `r ncol(gs)` attributes, many of which are redundant.  We focus on the following attributes for both the winner and loser of the match: games won, points won, retirement, break points faced, break points saved, aces, country of origin, and player attributes.  Additionally, we take into account the number of sets in a match, the surface type, and round of the tournament.  A subset of the data is shown in Table \ref{tab:data}.



```{r tab-data, include = TRUE, echo = FALSE}
w_id <- which(gs$winner_name == "Serena Williams")[1:2]
f_id <- which(gs$winner_name == "Roger Federer")[1:2]
n_id <- which(gs$winner_name == "Rafael Nadal")[1:2]
s_id <- which(gs$winner_name %in% c("Serena Williams", "Roger Federer", "Rafael Nadal"))
cols <- c("winner_name", "tourney_name", "year", "winner_ioc", "w_pointswon", "winner_rank", "l_pointswon", "loser_rank")
knitr::kable(gs[c(w_id, f_id, n_id), cols], format = "latex",
             row.names = FALSE, col.names = c("Winner", "Tournament", "Year", "W. IOC", "W. Points",  "W. Rank", "L. Points", "L. Rank"),
             caption = "\\label{tab:data}Example of the complete grand slam data.  It includes winner and loser attributes, match attributes, and tournament attributes.  Not all attributes are shown here.",
             booktabs = TRUE) %>% kable_styling(latex_options = "striped", "hold_position")
```

The secondary data is partial point by point data for grand slam matches.  In this data set, each row is a point in a match with details on who won the point, whether a player had a forced or unforced error, winner, ace, or net point win, and serve speed.  There is also tournament info such as surface, year, and time start.  Additional attributes include rally length, winner and final score of the match, retirement, and minutes played.  However, these additional attributes are only available for about 1/8 of the data.  

We aggregate the partial point by point data into partial match data, summing the total number of errors, winners, aces, net points, and taking the average service speed for each player in the match.  We then join the partial match data with the complete data to find the score and outcome of the match.  We do this by joining the features of tournament, year, player one, and player two.  This final data set consists of `r nrow(gs_pbp)` observations (compared to the 5080 in the original grand slams).  The median rank of the winners for the original data is `r median(gs$winner_rank, na.rm = TRUE)`, and the median rank for the winners of the partial data is `r median(gs_partial$winner_rank)`.  The same trend is true for the loser rank.  This means that it is more likely for better players to have court by court data, which may effects our analysis for models when using this more detailed yet partial data.  Additionally, we found that no women's point by point data was recorded for 2015.

All data is obtained from Jeff Sackmann's open website via the `R` package `deuce` [@sackmann2018; @deuce2017].  All steps of our analysis from collection to dissemination are freely available online.



## Early Data Analysis {#sec:eda}

### Examining the distribution of points earned

We first examine the distribution of points earned per match to assess normality. The distribution of points earned is approximately normal. This distribution is similar across tournament, with Wimbledon differing slightly from the other grand slams. As expected, there are more points earned in the WTA than the ATP due to the differing numbers of games played. Also unsurprisingly, the winners of the match tended to earn more points than the losers.   

```{r, fig.height=5, fig.width=10}

# grid.arrange(p1, p2, p3, ncol=3, widths=c(.25, .41, .34))


p2 <- ggplot(gs_players) + geom_density(aes(pointswon, color = tournament)) + 
  labs(x = "Points") + my_theme +
  scale_color_manual("Tournament", values=tournament_colors)

p3 <- ggplot(gs_players) + geom_density(aes(pointswon, color = league))+ 
  labs(x = "Points") +
  scale_color_manual("League", values=league_colors) +
  my_theme


# grid.arrange( p2, p3, ncol=2,
#              top = textGrob("Winning points by tournament and league",
#                             gp=gpar(fontsize=20)))

p1 <- ggplot(gs_players) + geom_density(aes(pointswon, color = factor(did_win))) + 
  labs(x = "Points") +
  scale_color_manual("Winner?", values=win_colors) +
  my_theme +
  facet_wrap(~league, ncol=1)

grid.arrange(p1, p2, ncol=2,
             top = textGrob("Distribution of points per match",
                            gp=gpar(fontsize=20, fontfamily="serif")),
              layout_matrix = rbind(c(NA, 1),
                                    c(2, 1),
                                    c(NA, 1)),
             heights=c(1, 3, 1))

```


### Home court advantage 

It is commonly thought that there is a home court advantage in grand slam games (SOURCE). In our data we find this to be true (i.e. French players win the French open more than French players win other slams). But, we also know that the home team is given preference for wild card bids (SOURCE) so potentially citizens of a given country play in "their" tournament more often than they play in other tournaments. We also find this to be true in our data for France, The United States, Australia, and Great Britain (i.e. the proportion of French players in the French Open is greater than the proportion of French players in other slams). 

Therefore, we want to see how the proportion of wins for the home country changes across the different tournaments. If there was really a home court advantage, the proportion of French wins each round would be higher at the French Open than the Australian Open, the US Open, and Wimbledon. The same would be true for Australia and the US. But, we see in \ref{fig:home-court} that this isn't the case. After accounting for the number of players from each country, we don't find a home court advantage in the grand slam. 

```{r, fig.height=3.5, fig.width=10, fig.align='center', fig.cap = "\\label{fig:home-court}"}
france_wins <- filter(gs_players, ioc == "FRA", round < "QF") %>% 
  group_by(tournament, round) %>% 
  summarise(win_prop = mean(did_win),
            win_prop_se = sqrt(win_prop*(1-win_prop)/n()))

us_wins <- filter(gs_players, ioc == "USA", round < "QF") %>% 
  group_by(tournament, round) %>% 
  summarise(win_prop = mean(did_win),
            win_prop_se = sqrt(win_prop*(1-win_prop)/n()))

aus_wins <- filter(gs_players, ioc == "AUS", round < "QF") %>% 
  group_by(tournament, round) %>% 
  summarise(win_prop = mean(did_win),
            win_prop_se = sqrt(win_prop*(1-win_prop)/n()))

gbr_wins <- filter(gs_players, ioc == "GBR", round < "QF") %>% 
  group_by(tournament, round) %>% 
  summarise(win_prop = mean(did_win),
            win_prop_se = sqrt(win_prop*(1-win_prop)/n()))

p1<- ggplot(france_wins, aes(round, win_prop, color=tournament, group=tournament)) + 
  geom_line() + 
  # geom_point() +
  labs(title = "French players",
       x = "", y = "Win proportion") + 
  scale_color_manual(" ", values=tournament_colors) + my_theme

p2 <- ggplot(us_wins, aes(round, win_prop, color=tournament, group=tournament)) + 
  geom_line() + 
  # geom_point() +
  labs(title = "American players",
       x = "", y = "Win proportion") +  
  scale_color_manual(" ", values=tournament_colors)  + my_theme

p3 <- ggplot(aus_wins, aes(round, win_prop, color=tournament, group=tournament)) + 
  geom_line() + 
  # geom_point() +
  labs(title = "Australian players",
       x = "", y = "Win proportion") + 
  scale_color_manual(" ", values=tournament_colors) + my_theme


p4 <- ggplot(gbr_wins, aes(round, win_prop, color=tournament, group=tournament)) + 
  geom_line() + 
  # geom_point() +
  labs(title = "British players",
       x = "", y = "Win proportion") + 
  scale_color_manual(" ", values=tournament_colors) + my_theme

ggarrange(p3, p1, p2,  p4, nrow=1, ncol=4, common.legend = TRUE, legend="bottom") %>%
grid.arrange(., top = textGrob("Home court advantage: debunked",
                            gp=gpar(fontsize=20, fontfamily="serif")),
             bottom = textGrob("Note: we only look at the first 4 rounds due to decreasing sample size",
                           just = "left",
                           gp=gpar(fontfamily="serif")))


ggplot(gs_players, aes(round, pointswon/(rank - opponent_rank), group=tournament)) + 
  geom_line()

ggplot(gs_players, aes(round, pointswon/(rank - opponent_rank), group=tournament)) + 
  geom_point()

filter(gs_players, ioc == "FRA", round < "QF", league == "WTA") %>%
ggplot( aes(x = ( opponent_rank - rank), y = (pointswon - (total_points - pointswon)),
            color = tournament)) + 
  geom_point() +
  geom_smooth(method = "lm", se=FALSE)

p1 <- filter(gs_players, ioc == "FRA", round < "QF", league == "WTA") %>%
ggplot( aes(x = ( opponent_rank - rank), y = did_win,
            color = tournament)) + 
  geom_point() +
  geom_smooth(method = "lm", se=FALSE) +
  labs(title = "French players",
      y = "Win proportion",
      x = " ") + 
  scale_color_manual(" ", values=tournament_colors) + my_theme +
  xlim(c(-1300, 800))  + scale_y_continuous(breaks = c(0, 1),
                                            labels =c("No", "Yes"),
                                            limits = c(0, 1))

p2 <-filter(gs_players, ioc == "AUS", round < "QF", league == "WTA") %>%
ggplot( aes(x = ( opponent_rank - rank), y = did_win,
            color = tournament)) + 
  geom_point() +
  geom_smooth(method = "lm", se=FALSE) +
  labs(title = "Australian players",
      y = "Win proportion",
      x = " ") + 
  scale_color_manual(" ", values=tournament_colors) + my_theme +
  xlim(c(-1300, 800))  + scale_y_continuous(breaks = c(0, 1),
                                            labels =c("No", "Yes"),
                                            limits = c(0, 1))

p3 <-filter(gs_players, ioc == "USA", round < "QF", league == "WTA") %>%
ggplot( aes(x = ( opponent_rank - rank), y = did_win,
            color = tournament)) + 
  geom_point() +
  geom_smooth(method = "lm", se=FALSE) +
  labs(title = "American players",
      y = "Win proportion") + 
  scale_color_manual(" ", values=tournament_colors) + my_theme +
  xlim(c(-1300, 800))  + scale_y_continuous(breaks = c(0, 1),
                                            labels =c("No", "Yes"),
                                            limits = c(0, 1))

p4 <-filter(gs_players, ioc == "GBR", round < "QF", league == "WTA") %>%
ggplot( aes(x = ( opponent_rank - rank), y = did_win,
            color = tournament)) + 
  geom_point() +
  geom_smooth(method = "lm", se=FALSE) +
  labs(title = "English players",
      y = "Win proportion") + 
  scale_color_manual(" ", values=tournament_colors) + my_theme +
  xlim(c(-1300, 800))  + scale_y_continuous(breaks = c(0, 1),
                                            labels =c("No", "Yes"),
                                            limits = c(0, 1))

# grid.arrange(p1, p2, p3, p4, nrow=2)


ggarrange(p1, p2, p3, p4, nrow=2, ncol=2, common.legend = TRUE, legend="bottom") %>%
grid.arrange(., top = textGrob("WTA",
                            gp=gpar(fontsize=30, fontfamily="serif")),
             bottom = textGrob("Note: we only look at the first 4 rounds due to decreasing sample size",
                           just = "left",
                           gp=gpar(fontfamily="serif"))) %>%
ggsave("plots/wta.jpg", ., width = 10, height = 8)


p1 <- filter(gs_players, ioc == "FRA", round < "QF", league == "ATP") %>%
ggplot( aes(x = ( opponent_rank - rank), y = did_win,
            color = tournament)) + 
  geom_point() +
  geom_smooth(method = "lm", se=FALSE) +
  labs(title = "French players",
      y = "Win proportion",
      x = " ") + 
  scale_color_manual(" ", values=tournament_colors) + my_theme +
  xlim(c(-1500, 1500))  + scale_y_continuous(breaks = c(0, 1),
                                            labels =c("No", "Yes"),
                                            limits = c(0, 1))

p2 <-filter(gs_players, ioc == "AUS", round < "QF", league == "ATP") %>%
ggplot( aes(x = ( opponent_rank - rank), y = did_win,
            color = tournament)) + 
  geom_point() +
  geom_smooth(method = "lm", se=FALSE) +
  labs(title = "Australian players",
      y = "Win proportion",
      x = " ") + 
  scale_color_manual(" ", values=tournament_colors) + my_theme +
  xlim(c(-1500, 1500))  + scale_y_continuous(breaks = c(0, 1),
                                            labels =c("No", "Yes"),
                                            limits = c(0, 1))

p3 <-filter(gs_players, ioc == "USA", round < "QF", league == "ATP") %>%
ggplot( aes(x = ( opponent_rank - rank), y = did_win,
            color = tournament)) + 
  geom_point() +
  geom_smooth(method = "lm", se=FALSE) +
  labs(title = "American players",
      y = "Win proportion") + 
  scale_color_manual(" ", values=tournament_colors) + my_theme +
  xlim(c(-1500, 1500))  + scale_y_continuous(breaks = c(0, 1),
                                            labels =c("No", "Yes"),
                                            limits = c(0, 1))

p4 <-filter(gs_players, ioc == "GBR", round < "QF", league == "ATP") %>%
ggplot( aes(x = ( opponent_rank - rank), y = did_win,
            color = tournament)) + 
  geom_point() +
  geom_smooth(method = "lm", se=FALSE) +
  labs(title = "English players",
      y = "Win proportion") + 
  scale_color_manual(" ", values=tournament_colors) + my_theme +
  xlim(c(-1500, 1500))  + scale_y_continuous(breaks = c(0, 1),
                                            labels =c("No", "Yes"),
                                            limits = c(0, 1))



ggarrange(p1, p2, p3, p4, nrow=2, ncol=2, common.legend = TRUE, legend="bottom") %>%
grid.arrange(., top = textGrob("ATP",
                            gp=gpar(fontsize=30, fontfamily="serif")),
             bottom = textGrob("Note: we only look at the first 4 rounds due to decreasing sample size",
                           just = "left",
                           gp=gpar(fontfamily="serif"))) %>%
ggsave("plots/atp.jpg", ., width = 10, height = 8)

```


## Spaniards on clay

```{r}

spain_wins <- filter(gs_players, ioc == "ESP", round < "QF") %>% 
  group_by(tournament, round) %>% 
  summarise(win_prop = mean(did_win),
            win_prop_se = sqrt(win_prop*(1-win_prop)/n()),
            avg_ranking = mean(rank),
            rank_se = sd(rank)/sqrt(n()))

prop.table(with(filter(gs_players, ioc == "ESP", round == "R128"),
                table(did_win, tournament)), 2)

with(filter(gs_players, ioc == "ESP", round == "R128"),
                table(did_win, tournament))

with(filter(gs_players, ioc == "ESP", round == "R128"),
     table(did_win, tournament)) %>%
  chisq.test(correct = TRUE)

```


It is also commonly thought that Spaniards play better on clay. We are interested in whether Spaniards win the French Open more than they win in other tournaments. It does appear that Spaniards are winning the French Open more than they are winning other tournaments as the line in \ref{fig:spain-clay} for the French Open is consistently higher than the other tournaments. But, this result is not significant (ENTER P VALUE). Interestingly, the ranking of Spaniards in the French Open is, on average, higher than other tournaments, meaning that, on average Spanish players in the French Open are, on average, worse than Spanish players in ther tournaments. 

```{r, fig.height=3.8, fig.width=8, out.width="80%", fig.align='center', fig.cap = "\\label{fig:spain-clay}"}

my_theme <-  theme_bw() + # White background, black and white theme
  theme(axis.text = element_text(size = 24),
        text = element_text(size = 28,
        family="serif"),
        plot.title = element_text(hjust = 0.5, size=34))

p1 <- ggplot(spain_wins, aes(round, win_prop, color=tournament, group=tournament)) + 
  geom_line(size=3) + 
  labs(title = "Win proportion among Spaniards",
       # caption = "Note: we only look at the first 4 rounds due to decreasing sample size",
       x = "", y = "Win proportion") + 
  scale_color_manual(guide=FALSE, values=tournament_colors,
                                labels = c("Australian Open\n(Plexicushion)",
                                           "French Open\n(Clay)",
                                           "US Open\n(DecoTurf)",
                                           "Wimbledon\n(Grass)")) + my_theme  

p2 <- ggplot(spain_wins, aes(round, avg_ranking, color=tournament, group=tournament, fill = tournament)) + 
  geom_line(size=3) + 
  labs(title = "Average ranking among Spaniards",
       x = " ",
       y = "Average rank") + 
  scale_color_manual(" ", values=tournament_colors,
                                labels = c("Australian Open\n(Plexicushion)",
                                           "French Open\n(Clay)",
                                           "US Open\n(DecoTurf)",
                                           "Wimbledon\n(Grass)")) + my_theme +
  guides(color = guide_legend(override.aes = list(size = 7))) 


ggarrange( p1, p2, nrow=1, ncol=2, common.legend = TRUE, legend="bottom") %>%
grid.arrange(top = textGrob("Spaniards perform better on Clay: confirmed?",
                            gp=gpar(fontsize=20, fontfamily="serif")),
             bottom = textGrob("Note: we only look at the first 4 rounds due to decreasing sample size",
                           # x = 0,
                           # y = 0.5,
                           just = "left",
                           gp=gpar(fontfamily="serif")))

ggarrange( p1, p2, nrow=1, ncol=2, common.legend = TRUE, legend="bottom") %>%
  ggsave("plots/spainards.jpg", ., height=7, width=16)


```


# Unforced errors and aces

We find that the distribution of errors and aces differ by tournament. Specifically, GAMES? in Wimbledon follow different ace and error patterns than the other tournaments. These GAMES? tend to cluster in the upper left hand part of the graph, meaning that at Wimbledon players are making fewer unforced errors and scoring more aces. It is known (SOURCE) that the ball moves faster on grass courts and so the ace result is unsuprising, but making fewer errors is unexpected, especially because players seldom practice on grass. 

```{r, out.width="70%", fig.width=7, fig.height=3.5, fig.align='center'}

my_theme <-  theme_bw() + # White background, black and white theme
  theme(axis.text = element_text(size = 24),
        text = element_text(size = 28,
        family="serif"),
        plot.title = element_text(hjust = 0.5, size=34))

ggplot(gs_partial, aes(w_n_ue + l_n_ue, w_n_aces + l_n_aces,
                           label = tournament, color=tournament)) + 
  geom_jitter(size=2) +
  labs( title = "Distribution of errors and aces differ by tournament",
        x = "Total unforced errors", y = "Total aces") +
  my_theme + scale_color_manual("Tournament",
                                values = tournament_colors,
                                labels = c("Australian Open\n(Plexicushion)\n",
                                           "French Open\n(Clay)\n",
                                           "US Open\n(DecoTurf)\n",
                                           "Wimbledon\n(Grass)\n")) + 
  geom_density_2d()

ggplot(gs_partial, aes(w_n_ue + l_n_ue, w_n_aces + l_n_aces,
                           label = tournament, color=tournament)) + 
  geom_jitter(size=1.5) +
  labs( title = "Distribution of errors and aces differ by tournament",
        x = "Total unforced errors", y = "Total aces") +
  my_theme + scale_color_manual("Tournament",
                                values = tournament_colors,
                                labels = c("Australian Open\n(Plexicushion)\n",
                                           "French Open\n(Clay)\n",
                                           "US Open\n(DecoTurf)\n",
                                           "Wimbledon\n(Grass)\n")) +
  stat_ellipse(type="t") +
  guides(color = guide_legend(override.aes = list(size = 7, shape=15))) 

ggsave("plots/errors_aces2.jpg", height = 6, width = 12)

```



## Tall players and aces

Another common thought about tennis is that taller players are better servers. We find this to be true and see a strong positive correlation between teh variables. We highlight some interesting players BLAH BLAH BLAH. 


```{r, fig.width=10, fig.height=4.8, fig.align='center'}

my_theme <-  theme_bw() + # White background, black and white theme
  theme(axis.text = element_text(size = 24),
        text = element_text(size = 28,
        family="serif"),
        plot.title = element_text(hjust = 0.5, size=34))

# my_theme <-  theme_bw() + # White background, black and white theme
#   theme(axis.text = element_text(size = 26),
#         text = element_text(size = 30,
#         family="serif"),
#         plot.title = element_text(hjust = 0.5, size=36))

set.seed(8)

atp_servers <- c("Ivo Karlovic", "John Isner", "Rafael Nadal",
                 "Roger Federer", "Andy Murray")
atp_servers <- sapply(atp_servers,
                      function(x) return(sample(which(gs_players$name == x), 2))) %>%
  as.numeric() %>% gs_players[., ]

wta_servers <- c("Karolina Pliskova", "Caroline Wozniacki",
                 "Venus Williams", "Serena Williams", "Madison Keys")
wta_servers <- sapply(wta_servers,
                      function(x) return(sample(which(gs_players$name == x), 2))) %>%
  as.numeric() %>% gs_players[., ]


p_atp <- gs_players %>% filter(league == "ATP") %>%
ggplot( aes(log(ht+1), log(ace+1))) + 
  geom_jitter(aes(color = tournament), size=1.5) + 
  # scale_color_manual(" ", values = tournament_colors) + 
  geom_smooth( method = "lm", color="black") + 
  geom_label_repel(data=atp_servers,
            aes(log(ht+1), log(ace+1), label=name),
            alpha=.8, seed=1234, show.legend=FALSE, size = 8) + 
  geom_label_repel(data=atp_servers,
            aes(log(ht+1), log(ace+1), label = name),
            seed=1234, fill=NA, show.legend=FALSE, size = 8) +
  labs(x = "log(height + 1)", title = "ATP") +
  my_theme + scale_color_manual("Tournament",
                                values = tournament_colors,
                                labels = c("Australian Open\n(Plexicushion)\n",
                                           "French Open\n(Clay)\n",
                                           "US Open\n(DecoTurf)\n",
                                           "Wimbledon\n(Grass)\n")) +
  guides(color = guide_legend(override.aes = list(size = 7, shape=15)))

p_wta <- gs_players %>% filter(league == "WTA") %>%
ggplot(aes(log(ht+1), log(ace+1))) + 
  geom_jitter(aes(color = tournament)) + 
  # scale_color_manual(" ", values = tournament_colors) + 
  geom_smooth(method = "lm", color="black") + 
  geom_label_repel(data=wta_servers,
            aes(log(ht+1), log(ace+1), label=name),
            alpha=.8, seed=1234, show.legend=FALSE, size = 8) + 
  geom_label_repel(data=wta_servers,
            aes( log(ht+1), log(ace+1), label=name),
            seed=1234, fill=NA, show.legend=FALSE, size = 8) +
  labs(x = "log(height + 1)", title = "WTA")+
  my_theme + scale_color_manual("Tournament",
                                values = tournament_colors,
                                labels = c("Australian Open\n(Plexicushion)\n",
                                           "French Open\n(Clay)\n",
                                           "US Open\n(DecoTurf)\n",
                                           "Wimbledon\n(Grass)\n")) +
  guides(color = guide_legend(override.aes = list(size = 7, shape=15))) 

# grid.arrange(p_atp, p_wta, nrow=1, widths=c(.4, .6),
#              top = textGrob("Taller players are better servers: confirmed",
#                             gp=gpar(fontsize=20, fontfamily="serif")))

ggarrange(p_atp, p_wta, common.legend = TRUE, legend="bottom") 
# %>%  grid.arrange(top = textGrob("Taller players are better servers: confirmed",
#                             gp=gpar(fontsize=20, fontfamily="serif")))

# ggsave("plots/aces.jpg", height=7, width=16)
ggsave("plots/aces2.jpg", height=7, width=16)




```




```{r, fig.width=6, fig.height=6, fig.align='center'}


# p_atp <- gs_players %>% filter(league == "ATP") %>%
# ggplot( aes(log(ht+1), log(ace+1))) + 
#   geom_jitter(aes(color = tournament)) + 
#   scale_color_manual(guide=FALSE, values = tournament_colors) + 
#   geom_smooth( method = "lm", se=FALSE, color="black") + 
#   geom_label_repel(data=atp_servers,
#             aes(log(ht+1), log(ace+1), label=name),
#             alpha=.6, seed=1234, show.legend=FALSE) + 
#   geom_label_repel(data=atp_servers,
#             aes(log(ht+1), log(ace+1), label = name),
#             seed=1234, fill=NA, show.legend=FALSE) +
#   labs(x = "log(height + 1)", title = "ATP") +
#   my_theme
# 
# # subset(filter(gs_players, league == "WTA"),
# #                                (log(ht+1) > 5.22 & log(ace+1) > 2.6) |
# #                                 (log(ht+1) > 5.225 & log(ace+1) < .5) | 
# #                                 (log(ht+1) < 5.13 & log(ace+1) > 2.1) | 
# #                                 (log(ht+1) < 5.09 & log(ace+1) > 1.5) |
# #                                  (log(ace + 1) > 2.82))
# p_wta <- gs_players %>% filter(league == "WTA") %>%
# ggplot(aes(log(ht+1), log(ace+1))) + 
#   geom_jitter(aes(color = tournament)) + 
#   scale_color_manual("Tournament", values = tournament_colors) + 
#   geom_smooth(aes(color = tournament), method = "lm", se=FALSE) + 
#   geom_label_repel(data=wta_servers,
#             aes(log(ht+1), log(ace+1), label=name),
#             alpha=.6, seed=1234, show.legend=FALSE) + 
#   geom_label_repel(data=wta_servers,
#             aes(log(ht+1), log(ace+1), label=name),
#             seed=1234, fill=NA, show.legend=FALSE) +
#   labs(x = "log(height + 1)", title = "WTA")+
#   my_theme + theme(legend.position="bottom")
# 
# 
# grid.arrange(p_atp, p_wta, nrow=2, heights = c(.46, .54),
#              top = textGrob("Taller players are better servers: confirmed",
#                             gp=gpar(fontsize=20, fontfamily="serif")))

```








### Linear regression for other outcomes

Instead of using `win' as the outcome variable, we now look at match statistics that may be more sensitive to court surface -- aces, net points won, and UEs -- and see if individual differences among players are detectable. We fit three additional models, each of the form $Y_i = \beta X_i + \delta_i$, where $\delta_i = \alpha_i T_i$, $T_i$ is the four grand slam tournaments, and $X_i$ includes the same variables as the model above. 

```{r, eval = FALSE}
gs_partial_players$atp = gs_partial_players$Tour == "atp"
gs_partial_players$year_fac = as.factor(gs_partial_players$year)
gs_partial_players$late_round = gs_partial_players$round >= "R16"
gs_partial_players$seeded = gs_partial_players$rank <= 32
gs_partial_players$opponent_seeded = gs_partial_players$opponent_rank <= 32
n_aces_mod = lmer(n_aces ~ late_round + log(rank) + log(opponent_rank) + year_fac + atp + (0 + tournament |name), data = gs_partial_players)
n_winners_mod = lmer(n_winners ~ late_round + log(rank) + log(opponent_rank) + year_fac + atp + (0 + tournament |name), data = gs_partial_players)
n_net_mod = lmer(n_netpt_w ~ late_round + log(rank) + log(opponent_rank) + year_fac + atp + (0 + tournament |name), data = gs_partial_players)
n_ue_mod = lmer(n_ue ~ late_round + log(rank) + log(opponent_rank) + year_fac + atp + (0 + tournament |name), data = gs_partial_players)
```

```{r}
load("../../data/n_aces_mod.rda")
load("../../data/n_net_mod.rda")
load("../../data/n_ue_mod.rda")
load("../../data/n_winners_mod.rda")
```

```{r, fig.height = 3.3, fig.width=10,  fig.cap = "\\label{fig:mixed-mods-stats}Estimated player-level effects for Williams, Federer and Nadal when modeling aces, net winners, and unforced errors."}

my_theme <-  theme_bw() + # White background, black and white theme
  theme(axis.text = element_text(size = 20),
        text = element_text(size = 24,
        family="serif"),
        plot.title = element_text(hjust = 0.5, size=26))

aces_ranef = as.data.frame(ranef(n_aces_mod, condVar = TRUE)) %>%
  mutate(tournament = gsub("tournament", "", term)) %>%
  filter(., grp == "Serena Williams" | grp == "Rafael Nadal" | grp == "Roger Federer") %>%
  ggplot(., aes(x = as.character(grp), y = condval,
                ymin = condval- 2*condsd, ymax = condval + 2*condsd, col = tournament)) +
  geom_errorbar(height = .5, position = position_dodge(width=.5), size =2) +
  ylab("Coefficient\n") + 
  xlab("") +
  ggtitle("Y = aces") + 
  scale_color_manual("", values=tournament_colors,
                                labels = c("Australian Open\n(Plexicushion)",
                                           "French Open\n(Clay)",
                                           "US Open\n(DecoTurf)",
                                           "Wimbledon\n(Grass)")) +
  my_theme +
  coord_flip() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()) +
  geom_hline(yintercept = 0, color = "grey") +
  guides(color = guide_legend(override.aes = list(size = 7))) 

# winners_ranef = as.data.frame(ranef(n_winners_mod, condVar = TRUE)) %>%
#   mutate(tournament = gsub("tournament", "", term)) %>%
#   filter(., grp == "Serena Williams" | grp == "Rafael Nadal" | grp == "Roger Federer") %>%
#   ggplot(., aes(x = as.character(grp), y = condval, ymin = condval- 2*condsd, ymax = condval + 2*condsd, col = tournament)) +
#   geom_errorbar(height = .5, position = position_dodge()) +
#   ylab("Coefficient\n") + 
#   xlab("") +
#   ggtitle("Winners") + 
#   scale_color_manual("", values=tournament_colors,
#                                 labels = c("Australian Open\n(Plexicushion)",
#                                            "French Open\n(Clay)",
#                                            "US Open\n(DecoTurf)",
#                                            "Wimbledon\n(Grass)")) +
#   my_theme  +
#   coord_flip() +
#   theme(panel.grid.major = element_blank(),
#         panel.grid.minor = element_blank(),
#         axis.text.y = element_blank()) +
#   geom_hline(yintercept = 0, color = "grey")


nets_ranef = as.data.frame(ranef(n_net_mod, condVar = TRUE)) %>%
  mutate(tournament = gsub("tournament", "", term)) %>%
  filter(., grp == "Serena Williams" | grp == "Rafael Nadal" | grp == "Roger Federer") %>%
  ggplot(., aes(x = as.character(grp), y = condval, ymin = condval- 2*condsd, ymax = condval + 2*condsd, col = tournament)) +
  geom_errorbar(height = .5, position = position_dodge(width=.5), size =2) +
  ylab("Coefficient\n") + 
  xlab("") +
  ggtitle("Y = points won at net") + 
  scale_color_manual("", values=tournament_colors,
                                labels = c("Australian Open\n(Plexicushion)",
                                           "French Open\n(Clay)",
                                           "US Open\n(DecoTurf)",
                                           "Wimbledon\n(Grass)")) +
  my_theme  +
  coord_flip() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text.y = element_blank()) +
  geom_hline(yintercept = 0, color = "grey") +
  guides(color = guide_legend(override.aes = list(size = 7))) 


ue_ranef = as.data.frame(ranef(n_ue_mod, condVar = TRUE)) %>%
  mutate(tournament = gsub("tournament", "", term)) %>%
  filter(., grp == "Serena Williams" | grp == "Rafael Nadal" | grp == "Roger Federer") %>%
  ggplot(., aes(x = as.character(grp), y = condval, ymin = condval- 2*condsd, ymax = condval + 2*condsd, col = tournament)) +
  geom_errorbar(height = .5, position = position_dodge(width=.5), size =2) +
  ylab("Coefficient\n") + 
  xlab("") +
  ggtitle("Y = unforced errors") + 
  scale_color_manual("", values=tournament_colors,
                                labels = c("Australian Open\n(Plexicushion)",
                                           "French Open\n(Clay)",
                                           "US Open\n(DecoTurf)",
                                           "Wimbledon\n(Grass)")) +
  my_theme  +
  coord_flip() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text.y = element_blank()) +
  geom_hline(yintercept = 0, color = "grey") +
  guides(color = guide_legend(override.aes = list(size = 7))) 


#grid.arrange(aces_ranef, nets_ranef, ue_ranef, nrow = 1, widths = c(.38, .22, .45))

ggarrange(aces_ranef, nets_ranef, ue_ranef, nrow=1, ncol=3,
          common.legend = TRUE, legend="bottom", widths = c(.42, .29, .29)) %>%
ggsave("plots/player_effects.jpg", ., width=14, height=5)

```

