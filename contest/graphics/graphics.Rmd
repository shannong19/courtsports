---
title: "Graphics"
author: "We have no names"
output:
  pdf_document:
    fig_caption: yes
    keep_tex: yes
    number_sections: no
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(warning=FALSE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(cache = TRUE)
library(deuce)
library(dplyr)
library(ggplot2)
library(forcats)
library(stringr)
library(knitr)
library(kableExtra)
library(pander)
library(gridExtra)

## To change into library(courtsports)
devtools::load_all("../..")
```


```{r data-cleaning, include = FALSE}
## Load WTA and ATP matches from deuce package
data(atp_matches)
data(wta_matches)

## Clean data
gs <- clean_matches_data(atp_matches = atp_matches,
                         wta_matches = wta_matches,
                         start_year = 2013,
                         end_year = 2017,
                         include_quals = FALSE,
                         level = "Grand Slams")

 

## Extract sets, points, and games
gs <- extract_sgp(gs)

## Make into player data
gs_players <- matches_to_player_data(gs,
                                     w_opp_vars = "loser_rank",
                                     l_opp_vars = "winner_rank",
                                     opp_var_names = "opponent_rank")

```

# Univariate distributions

## Points won 


```{r, fig.height=4, fig.width=12}
p1 <- ggplot(gs_players) + geom_histogram(aes(pointswon), bins=40) + 
  labs(x = "Winner points")

p2 <- ggplot(gs_players) + geom_density(aes(pointswon, color = tournament)) + 
  labs(x = "Winner points")

p3 <- ggplot(gs_players) + geom_density(aes(pointswon, color = league))+ 
  labs(x = "Winner points")

grid.arrange(p1, p2, p3, ncol=3, widths=c(.25, .41, .34))

```

```{r, fig.height=3.5, fig.width=10, fig.align='center'}

p1 <- ggplot(gs) + geom_point(aes(w_pointswon, l_pointswon)) + 
  geom_abline(slope=1, intercept=0, color="red") + 
  labs(x = "Winner points", y = "Loser points")

p2 <- ggplot(gs) + geom_point(aes(w_pointswon, l_pointswon, color = league), alpha=.3) + 
    scale_color_manual(values=c("#339966", "#336699")) +
  geom_abline(slope=1, intercept=0, color="red") + 
  geom_smooth(aes(w_pointswon, l_pointswon, color = league), method='lm') + 
  labs(x = "Winner points", y = "Loser points")

grid.arrange(p1, p2, ncol=2, widths=c(.48, .52))

```



## Games won

```{r, fig.height=4, fig.width=12}

p1 <- ggplot(gs_players) + geom_histogram(aes(gameswon), bins=30)+ 
  labs(x = "Winner games")

p2 <- ggplot(gs_players) + geom_density(aes(gameswon, color = tournament))+ 
  labs(x = "Winner games")

p3 <- ggplot(gs_players) + geom_density(aes(gameswon, color = league))+ 
  labs(x = "Winner games")

grid.arrange(p1, p2, p3, ncol=3, widths=c(.25, .41, .34))

```

```{r, fig.height=3.5, fig.width=10, fig.align='center'}

p1 <- ggplot(gs) + geom_point(aes(w_gameswon, l_gameswon)) + 
  geom_abline(slope=1, intercept=0, color="red") + 
  labs(x = "Winner games", y = "Loser games")


p2 <- ggplot(gs) + geom_point(aes(w_gameswon, l_gameswon, color = league), alpha=.3) + 
    scale_color_manual(values=c("#339966", "#336699")) +
  geom_abline(slope=1, intercept=0, color="red") + 
  geom_smooth(aes(w_gameswon, l_gameswon, color = league), method='lm')  + 
  labs(x = "Winner games", y = "Loser games")

grid.arrange(p1, p2, ncol=2, widths=c(.48, .52))

```


# Spain vs. tournament

## Is being a winner from Spain independent of tournament? 


```{r, fig.height=3.2, fig.width=6, fig.align='center'}
gs <- mutate(gs, 
             winner_ioc_spain = ifelse(winner_ioc == "ESP", "Spain", "Other"))

props <- gs %>% group_by(tournament, winner_ioc_spain) %>%
        tally() %>%
        group_by(tournament) %>%
        mutate(pct = n / sum(n))

ggplot(props, aes(tournament, pct, fill = winner_ioc_spain)) +
        geom_bar(stat = "identity") +
        scale_fill_manual("Country of origin",
                          values = c( "#FFC400", "#C60B1E")) + 
  labs(x = " ", y = "Proportion", title = "Spanish players win the French Open\nmore often than other tournaments") + 
  geom_text(data = filter(props, winner_ioc_spain == "Spain"), 
            aes(tournament, y = pct + .05, label = paste0(round(pct*100, 2),"%")),
                       size=4) + theme_bw() + theme(plot.title = element_text(hjust = 0.5))
```

```{r sample, echo=FALSE, results='asis'}
library(xtable)

spain_vs_tourn <- with(gs, table(tournament, winner_ioc_spain))

t1 <- kable(spain_vs_tourn, format = "latex", booktabs = TRUE)
t2 <- kable(chisq.test(spain_vs_tourn)$expected, format = "latex", booktabs = TRUE)
spain_vs_tourn_chisq <- chisq.test(spain_vs_tourn)

t1 <- kable(spain_vs_tourn, format = "latex", booktabs = TRUE)
t2 <- kable(spain_vs_tourn_chisq$expected, format = "latex", booktabs = TRUE)

cat(c("\\begin{table}[!htb]
    \\begin{minipage}{.5\\linewidth}
      \\caption{Actual table}
      \\centering",
        t1,
    "\\end{minipage}%
    \\begin{minipage}{.5\\linewidth}
      \\centering
        \\caption{Expected table}",
        t2,
    "\\end{minipage} 
\\end{table}"
))  
```


```{r}
spain_vs_tourn_chisq %>% 
  pander()
```

\newpage

## But do Spaniards enter the French open more than they do other tournaments? 

We look at players in the *first round* of all tournaments. 


```{r, fig.height=3.2, fig.width=6, fig.align='center'}

mini.d <- bind_rows(select(filter(gs, round == "R128"), tournament, winner_ioc) %>% rename(ioc = winner_ioc),
            select(filter(gs, round == "R128"), tournament, loser_ioc) %>% rename(ioc = loser_ioc)) %>%
  mutate(ioc_spain = ifelse(ioc == "ESP", "Spain", "Other"))

props <- mini.d %>% group_by(tournament, ioc_spain) %>%
        tally() %>%
        group_by(tournament) %>%
        mutate(pct = n / sum(n))

ggplot(props, aes(tournament, pct, fill = ioc_spain)) +
        geom_bar(stat = "identity") +
        scale_fill_manual("Country of origin",
                          values = c( "#FFC400", "#C60B1E")) + 
  labs(x = " ", y = "Proportion",
       title = "Spanish players enter the French Open\nmore often than other tournaments") + 
  geom_text(data = filter(props, ioc_spain == "Spain"), 
            aes(tournament, y = pct + .05, label = paste0(round(pct*100, 2),"%")),
                       size=4)  + theme_bw() + theme(plot.title = element_text(hjust = 0.5))

```

```{r}
with(mini.d, table(tournament, ioc_spain)) %>%
  chisq.test() %>%
  pander()
```

Yes, but not significantly more. 


# Home court advantage

## France

```{r, fig.height=3.2, fig.width=6, fig.align='center'}

gs <- mutate(gs, 
             winner_ioc_france = ifelse(winner_ioc == "FRA", "France", "Other"))

props <- gs %>% group_by(tournament, winner_ioc_france) %>%
        tally() %>%
        group_by(tournament) %>%
        mutate(pct = n / sum(n))

ggplot(props, aes(tournament, pct, fill = factor(winner_ioc_france, levels = c("Other", "France")))) +
        geom_bar(stat = "identity") +
        scale_fill_manual("Country of origin",
                          values = c("#F42A41", "#00209F")) + 
  labs(x = " ", y = "Proportion", title = "French players win the French Open\nmore often than other tournaments") + 
  geom_text(data = filter(props, winner_ioc_france == "France"), 
            aes(tournament, y = pct + .05, label = paste0(round(pct*100, 2),"%")),
                       size=4)  + theme_bw() + theme(plot.title = element_text(hjust = 0.5))

```

```{r, echo=FALSE, results='asis'}
library(xtable)

france_vs_tourn <- with(gs, table(tournament, winner_ioc_france))

france_vs_tourn_chisq <- chisq.test(france_vs_tourn)

t1 <- kable(france_vs_tourn, format = "latex", booktabs = TRUE)
t2 <- kable(france_vs_tourn_chisq$expected, format = "latex", booktabs = TRUE)

cat(c("\\begin{table}[!htb]
    \\begin{minipage}{.5\\linewidth}
      \\caption{Actual table}
      \\centering",
        t1,
    "\\end{minipage}%
    \\begin{minipage}{.5\\linewidth}
      \\centering
        \\caption{Expected table}",
        t2,
    "\\end{minipage} 
\\end{table}"
))  
```


```{r}
france_vs_tourn_chisq %>% 
  pander()
```


```{r, fig.height=3.2, fig.width=6, fig.align='center'}

mini.d <- mini.d %>%
  mutate(ioc_france = ifelse(ioc == "FRA", "France", "Other"))

props <- mini.d %>% group_by(tournament, ioc_france) %>%
        tally() %>%
        group_by(tournament) %>%
        mutate(pct = n / sum(n))

ggplot(props, aes(tournament, pct, fill = factor(ioc_france, levels = c("Other", "France")))) +
        geom_bar(stat = "identity") +
        scale_fill_manual("Country of origin",
                          values = c("#F42A41", "#00209F")) + 
  labs(x = " ", y = "Proportion",
       title = "French players enter the French Open\nmore often than other tournaments") + 
  geom_text(data = filter(props, ioc_france == "France"), 
            aes(tournament, y = pct + .05, label = paste0(round(pct*100, 2),"%")),
                       size=4)  + theme_bw() + theme(plot.title = element_text(hjust = 0.5))

```

```{r}
with(mini.d, table(tournament, ioc_france)) %>%
  chisq.test() %>%
  pander()
```

*Yes, significantly.*

\newpage

## United States

```{r, fig.height=3.2, fig.width=6, fig.align='center'}

gs <- mutate(gs, 
             winner_ioc_usa = ifelse(winner_ioc == "USA", "USA", "Other"))

props <- gs %>% group_by(tournament, winner_ioc_usa) %>%
        tally() %>%
        group_by(tournament) %>%
        mutate(pct = n / sum(n))

ggplot(props, aes(tournament, pct, fill = factor(winner_ioc_usa, levels = c("Other", "USA")))) +
        geom_bar(stat = "identity") +
        scale_fill_manual("Country of origin",
                          values = c( "#002868", "#BF0A30")) + 
  labs(x = " ", y = "Proportion", title = "American players win the U.S. Open\nmore often than other tournaments") + 
  geom_text(data = filter(props, winner_ioc_usa == "USA"), 
            aes(tournament, y = pct + .05, label = paste0(round(pct*100, 2),"%")),
                       size=4,
            color="white")  + theme_bw() + theme(plot.title = element_text(hjust = 0.5))

```

```{r, echo=FALSE, results='asis'}
usa_vs_tourn <- with(gs, table(tournament, winner_ioc_usa))

usa_vs_tourn_chisq <- chisq.test(usa_vs_tourn)

t1 <- kable(usa_vs_tourn, format = "latex", booktabs = TRUE)
t2 <- kable(usa_vs_tourn_chisq$expected, format = "latex", booktabs = TRUE)

# cat(c("\\begin{table}[!htb]
#     \\begin{minipage}{.5\\linewidth}
#       \\caption{Actual table}
#       \\centering",
#         t1,
#     "\\end{minipage}%
#     \\begin{minipage}{.5\\linewidth}
#       \\centering
#         \\caption{Expected table}",
#         t2,
#     "\\end{minipage} 
# \\end{table}"
# ))  
```


```{r}
usa_vs_tourn_chisq %>% 
  pander()
```


```{r, fig.height=3.2, fig.width=6, fig.align='center'}

mini.d <- mini.d %>%
  mutate(ioc_usa = ifelse(ioc == "USA", "USA", "Other"))

props <- mini.d %>% group_by(tournament, ioc_usa) %>%
        tally() %>%
        group_by(tournament) %>%
        mutate(pct = n / sum(n))

ggplot(props, aes(tournament, pct, fill = factor(ioc_usa, levels = c("Other", "USA")))) +
        geom_bar(stat = "identity") +
        scale_fill_manual("Country of origin",
                          values = c( "#002868", "#BF0A30")) + 
  labs(x = " ", y = "Proportion",
       title = "American players enter the U.S. Open\nmore often than other tournaments") + 
  geom_text(data = filter(props, ioc_usa == "USA"), 
            aes(tournament, y = pct + .05, label = paste0(round(pct*100, 2),"%")),
                       size=4,
            color="white")  + theme_bw() + theme(plot.title = element_text(hjust = 0.5))

```

```{r}
with(mini.d, table(tournament, ioc_usa)) %>%
  chisq.test() %>%
  pander()
```



## Australia

```{r, fig.height=3.2, fig.width=6, fig.align='center'}

gs <- mutate(gs, 
             winner_ioc_Australia = ifelse(winner_ioc == "AUS", "Australia", "Other"))

props <- gs %>% group_by(tournament, winner_ioc_Australia) %>%
        tally() %>%
        group_by(tournament) %>%
        mutate(pct = n / sum(n))

ggplot(props, aes(tournament, pct, fill = factor(winner_ioc_Australia, levels = c("Other", "Australia")))) +
        geom_bar(stat = "identity", color="grey") +
        scale_fill_manual("Country of origin",
                          values = c("#FFFFFF", "#012169")) + 
  labs(x = " ", y = "Proportion", title = "Australian players win the Australian Open\nmore often than other tournaments") + 
  geom_text(data = filter(props, winner_ioc_Australia == "Australia"), 
            aes(tournament, y = pct + .05, label = paste0(round(pct*100, 2),"%")),
                       size=4)  + theme_bw() + theme(plot.title = element_text(hjust = 0.5))

```

```{r, echo=FALSE, results='asis'}
Australia_vs_tourn <- with(gs, table(tournament, winner_ioc_Australia))

Australia_vs_tourn_chisq <- chisq.test(Australia_vs_tourn)

t1 <- kable(Australia_vs_tourn, format = "latex", booktabs = TRUE)
t2 <- kable(Australia_vs_tourn_chisq$expected, format = "latex", booktabs = TRUE)

cat(c("\\begin{table}[!htb]
    \\begin{minipage}{.5\\linewidth}
      \\caption{Actual table}
      \\centering",
        t1,
    "\\end{minipage}%
    \\begin{minipage}{.5\\linewidth}
      \\centering
        \\caption{Expected table}",
        t2,
    "\\end{minipage} 
\\end{table}"
))  
```


```{r}
Australia_vs_tourn_chisq %>% 
  pander()
```


```{r, fig.height=3.2, fig.width=6, fig.align='center'}

mini.d <- mini.d %>%
  mutate(ioc_Australia = ifelse(ioc == "AUS", "Australia", "Other"))

props <- mini.d %>% group_by(tournament, ioc_Australia) %>%
        tally() %>%
        group_by(tournament) %>%
        mutate(pct = n / sum(n))

ggplot(props, aes(tournament, pct, fill = factor(ioc_Australia, levels = c("Other", "Australia")))) +
        geom_bar(stat = "identity", color="grey") +
        scale_fill_manual("Country of origin",
                          values = c("#FFFFFF", "#012169")) + 
  labs(x = " ", y = "Proportion",
       title = "Australian players enter the Australian Open\nmore often than other tournaments") + 
  geom_text(data = filter(props, ioc_Australia == "Australia"), 
            aes(tournament, y = pct + .05, label = paste0(round(pct*100, 2),"%")),
                       size=4)  + theme_bw() + theme(plot.title = element_text(hjust = 0.5))

```

```{r}
with(mini.d, table(tournament, ioc_Australia)) %>%
  chisq.test() %>%
  pander()
```


# Conclusions

* Spaniards win the French Open more often than they win other tournaments, and this difference is significant. They play in the French Open more often than they play in other tournaments, but not significantly. 

* French win the French Open more often than they win other tournaments, but this difference is (barely) insignificant. They play in the French Open more often than they play in other tournaments, at a significantly higher rate.

* Americans win the US Open more often than they win other tournaments, and this difference is significant. But, they play in the US Open more often than they play in other tournaments, at a significantly higher rate.

* Australians win the US Open more often than they win other tournaments, and this difference is significant. But, they play in the Australian Open more often than they play in other tournaments, at a significantly higher rate.



# Pairs

```{r, fig.height=12, fig.width=12}
library(GGally)

vars <- c("ht", "age", "rank", "opponent_rank", "ace", "df", "svpt", "1stIn", "SvGms", "bpSaved",
          "bpFaced", "pointswon", "gameswon")

ggpairs(gs_players,
        columns = which(names(gs_players) %in% vars),
        mapping=ggplot2::aes(colour = factor(did_win)))

```


## Follow-up

```{r, fig.height=3, fig.width=4}
ggplot(gs_players) + geom_point(aes(log(ht+1), log(ace+1), color = factor(did_win)))
```


# MDS 

```{r}
gs_num <- select(gs, w_ace, w_df, w_svpt, w_1stIn, w_1stWon, w_2ndWon,
                w_bpSaved, w_bpFaced) %>%
na.omit()

mds <- cmdscale(dist(scale(gs_num)), k = 2) %>%
  as.data.frame()  # default column names will be V1, V2

mds$tournament <- select(gs, w_ace, w_df, w_svpt, w_1stIn, w_1stWon, w_2ndWon,
                w_bpSaved, w_bpFaced, tournament) %>%
na.omit() %>% pull( tournament)

ggplot(mds, aes(V1, V2, label = tournament, color=tournament)) + geom_text()
```


```{r}
gs_num <- select(gs, w_ace, w_df, w_svpt, w_1stIn,
                w_bpSaved, w_bpFaced) %>%
na.omit()

mds <- cmdscale(dist(scale(gs_num)), k = 2) %>%
  as.data.frame()  # default column names will be V1, V2

mds$tournament <- select(gs, w_ace, w_df, w_svpt, w_1stIn,
                w_bpSaved, w_bpFaced, tournament) %>%
na.omit() %>% pull( tournament)

ggplot(mds, aes(V1, V2, label = tournament, color=tournament)) + geom_text()
```


